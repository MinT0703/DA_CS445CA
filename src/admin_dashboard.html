<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard - BestFood</title>

  <!-- icons + Chart.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- reuse project's global stylesheet -->
  <link rel="stylesheet" href="./style.css">

  <style>
    /* small admin-specific overrides */
    .admin-wrap { max-width:1200px; margin:24px auto; padding: 0 20px; display:grid; grid-template-columns: 260px 1fr; gap:18px; align-items:start; }
    .admin-sidebar {
      background:#2f3f49; color:#fff; border-radius:12px; padding:18px; height:calc(100vh - 120px); position:sticky; top:80px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .admin-sidebar h4 { color:#fff; margin-bottom:12px; }
    .admin-sidebar a { display:flex; gap:10px; align-items:center; color:#cbd8de; padding:8px 10px; border-radius:8px; text-decoration:none; margin-bottom:6px; }
    .admin-sidebar a.active, .admin-sidebar a:hover { background: rgba(255,255,255,0.04); color:#fff; }
    .admin-main { display:flex; flex-direction:column; gap:18px; }

    .card-panel { background:#fff; border-radius:12px; padding:18px; box-shadow: var(--shadow); }
    .kpi-row { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
    .kpi { background:#fff; border-radius:10px; padding:14px; text-align:center; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    .kpi .num { font-size:20px; font-weight:800; color:var(--primary-color); }
    .top-dishes-table { width:100%; border-collapse:collapse; }
    .top-dishes-table th, .top-dishes-table td { text-align:left; padding:10px 12px; border-bottom:1px solid #f1f1f1; }
    .badge-role { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }

    /* responsive */
    @media (max-width: 900px) {
      .admin-wrap { grid-template-columns: 1fr; }
      .admin-sidebar { position:relative; height:auto; top:0; }
      .kpi-row { grid-template-columns: repeat(2,1fr); }
    }
    #revenueChart {
    height: 220px !important;
    max-height: 360px;
    width: 100% !important;
    display: block;
  }

  .card-panel { overflow: hidden; }
  </style>
</head>
<body>

  <!-- header (reuse project header pattern) -->
  <header class="header">
    <div class="container">
      <div class="logo">Best<span>Food</span></div>
      <nav class="nav" id="nav">
        <a href="admin_dashboard.html">Dashboard</a>
        <a href="admin_accounts.html">Tài Khoản</a>
        <a href="admin_menu.html">Món Ăn</a>
        <a href="admin_orders.html">Đơn Hàng</a>
        <a href="admin_promos.html">Voucher</a>
        <a href="login.html">Đăng xuất</a>
      </nav>
    </div>
  </header>

  <main class="admin-wrap">
    <!-- SIDEBAR -->
    <aside class="admin-sidebar" aria-label="Admin sidebar">
      <h4>Quản trị</h4>
      <a href="admin_dashboard.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a>
      <a href="admin_accounts.html"><i class="fas fa-users"></i> Quản lý Tài khoản</a>
      <a href="admin_menu.html"><i class="fas fa-utensils"></i> Quản lý Món ăn</a>
      <a href="admin_orders.html"><i class="fas fa-receipt"></i> Quản lý Đơn hàng</a>
      <a href="admin_promos.html"><i class="fas fa-tag"></i> Quản lý Khuyến mãi</a>
      <hr style="border-color: rgba(255,255,255,.04); margin:12px 0">
      <div style="font-size:13px; color:#9fb0b9">Xin chào, Admin</div>
    </aside>

    <!-- MAIN -->
    <section class="admin-main">

      <!-- Title -->
      <div class="card-panel">
        <h2 style="margin:0 0 6px">Dashboard Admin</h2>
        <p class="muted" style="margin:0">Tổng quan doanh thu & món được đặt nhiều.</p>
      </div>

      <!-- KPIs -->
      <div class="kpi-row">
        <div class="kpi card-panel">
          <div class="muted small">Doanh thu (30 ngày)</div>
          <div id="kpiRevenue" class="num">— đ</div>
        </div>
        <div class="kpi card-panel">
          <div class="muted small">Số đơn (30 ngày)</div>
          <div id="kpiOrders" class="num">—</div>
        </div>
        <div class="kpi card-panel">
          <div class="muted small">Món bán chạy</div>
          <div id="kpiTopDish" class="num">—</div>
        </div>
      </div>

      <!-- Charts + table -->
      <div style="display:grid; grid-template-columns: 1fr 420px; gap:18px;">
        <!-- Left: revenue chart -->
        <div class="card-panel">
          <h3 style="margin-top:0">Doanh thu theo ngày</h3>
          <canvas id="revenueChart" height="160" aria-label="Biểu đồ doanh thu"></canvas>
        </div>

        <!-- Right: top dishes -->
        <div class="card-panel">
          <h3 style="margin-top:0">Top món được đặt nhiều</h3>
          <table class="top-dishes-table" id="topDishesTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Món</th>
                <th>Số lượng</th>
                <th>Doanh thu</th>
              </tr>
            </thead>
            <tbody>
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>
      </div>

    </section>
  </main>

<script>
  // CONFIG: API endpoints (thay nếu cần)
  const API_STATS = '/api/admin/stats';      // { orders30, revenue30, top_dishes: [{name, qty, revenue}], revenue_days: [{date, amount}], recent_orders: [...] }
  const USE_API = false; // set true nếu có backend tương thích

  // demo fallback data (useful for testing offline)
  const demo = {
    orders30: 324,
    revenue30: 15432000,
    top_dishes: [
      { name: 'Phở Bò', qty: 128, revenue: 128*65000 },
      { name: 'Bún chả', qty: 97, revenue: 97*59000 },
      { name: 'Cơm tấm sườn', qty: 86, revenue: 86*70000 },
      { name: 'Gà rán', qty: 72, revenue: 72*85000 },
      { name: 'Bánh mì kẹp', qty: 60, revenue: 60*30000 }
    ],
    revenue_days: Array.from({length:30}).map((_,i)=>{
      const d = new Date();
      d.setDate(d.getDate() - (29 - i));
      return { date: d.toISOString().slice(0,10), amount: Math.round(200000 + Math.random()*700000) };
    }),
    recent_orders: [
      { id: 'ORD-169001', customer: 'Nguyễn A', total: 120000, at: '2025-11-30 12:12' },
      { id: 'ORD-169002', customer: 'Lê B', total: 210000, at: '2025-11-30 11:55' }
    ]
  };

  // helpers
  const money = v => (Number(v)||0).toLocaleString('vi-VN') + ' đ';

  async function loadStats(){
    if(USE_API){
      try{
        const res = await fetch(API_STATS, { headers: {Accept: 'application/json'} });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        // normalize expected shape or fallback to demo
        return json;
      } catch(err){
        console.warn('API stats failed, using demo', err);
        return demo;
      }
    } else {
      return demo;
    }
  }

  function renderKPIs(data){
    document.getElementById('kpiRevenue').textContent = money(data.revenue30 || 0);
    document.getElementById('kpiOrders').textContent = (data.orders30 || 0).toLocaleString();
    document.getElementById('kpiTopDish').textContent = (data.top_dishes && data.top_dishes[0]) ? data.top_dishes[0].name : '—';
  }

  function renderTopDishes(data){
    const tbody = document.querySelector('#topDishesTable tbody');
    tbody.innerHTML = '';
    (data.top_dishes || []).forEach((d, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>#${idx+1}</td>
                      <td>${escapeHtml(d.name)}</td>
                      <td>${(d.qty || 0).toLocaleString()}</td>
                      <td style="font-weight:800">${money(d.revenue || (d.qty||0)*(d.price||0))}</td>`;
      tbody.appendChild(tr);
    });
    if((data.top_dishes||[]).length === 0){
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Không có dữ liệu</td></tr>`;
    }
  }

  function renderRecentOrders(data){
    const list = document.getElementById('recentOrdersList');
    const items = data.recent_orders || [];
    if(!items.length){ list.innerHTML = 'Chưa có đơn hàng mới.'; return; }
    list.innerHTML = items.slice(0,6).map(o => `
      <div class="item" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid #f3f4f6;border-radius:8px;margin-bottom:8px">
        <div>
          <div style="font-weight:700">${escapeHtml(o.customer)} <span style="font-weight:600;color:#6b7280;font-size:13px">(${o.id})</span></div>
          <div class="muted small">${escapeHtml(o.at || '')}</div>
        </div>
        <div style="font-weight:800">${money(o.total)}</div>
      </div>
    `).join('');
  }

  function renderRevenueChart(ctx, revenue_days){
    const labels = (revenue_days || []).map(r => r.date.slice(5).replace('-','/'));
    const data = (revenue_days || []).map(r => r.amount || 0);
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Doanh thu',
          data,
          fill: true,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 2,
          backgroundColor: (ctx) => {
            const g = ctx.chart.ctx.createLinearGradient(0,0,0,200);
            g.addColorStop(0, 'rgba(231,76,60,0.18)');
            g.addColorStop(1, 'rgba(231,76,60,0.02)');
            return g;
          },
          borderColor: 'rgba(231,76,60,0.95)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: {
            ticks: { callback: v => (Number(v)||0).toLocaleString() },
            grid: { color: '#f5f5f5' }
          }
        }
      }
    });
  }

  function escapeHtml(s=''){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // init
  (async function init(){
    const stats = await loadStats();
    // ensure expected fields for demo compatibility
    const normalized = {
      orders30: stats.orders30 ?? stats.totalOrders30 ?? 0,
      revenue30: stats.revenue30 ?? stats.totalRevenue30 ?? stats.revenue ?? 0,
      top_dishes: stats.top_dishes ?? stats.most_ordered ?? [],
      revenue_days: stats.revenue_days ?? stats.daily_revenue ?? stats.revenue_days ?? (stats.revenue_days || demo.revenue_days),
      recent_orders: stats.recent_orders ?? stats.latest_orders ?? []
    };

    renderKPIs(normalized);
    renderTopDishes(normalized);
    renderRecentOrders(normalized);

    const ctx = document.getElementById('revenueChart').getContext('2d');
    renderRevenueChart(ctx, normalized.revenue_days);
  })();

</script>

</body>
</html>
