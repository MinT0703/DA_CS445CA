<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tài khoản của tôi - BestFood</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="./style.css">

  <style>
    .account-wrap { max-width:1200px; margin: 20px auto; padding: 20px; }
    .account-grid { display:grid; grid-template-columns: 280px 1fr; gap:18px; align-items:start; }
    @media(max-width:900px){ .account-grid { grid-template-columns: 1fr; } }

    .sidebar {
      background:#fff; border-radius:12px; padding:16px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:8px;
    }
    .sidebar .user {
      display:flex; gap:12px; align-items:center; padding-bottom:8px; border-bottom:1px solid #f3f4f6;
    }
    .avatar-sm { width:64px; height:64px; border-radius:12px; object-fit:cover; }
    .nav-item {
      display:flex; align-items:center; gap:12px; padding:10px; border-radius:10px; cursor:pointer;
      color:var(--dark-color); font-weight:600; text-decoration:none;
    }
    .nav-item:hover { background:#f8f5f5; }
    .nav-item.active { background: rgba(231,76,60,.08); color:var(--primary-color); }

    .panel { background:#fff; border-radius:12px; padding:18px; box-shadow:var(--shadow); }
    .profile-row { display:flex; gap:16px; align-items:center; }
    .profile-row .thumb { width:110px; height:110px; border-radius:12px; object-fit:cover; border:1px solid #f3f4f6; }

    .orders-list { display:flex; flex-direction:column; gap:12px; }
    .order { display:flex; justify-content:space-between; gap:12px; padding:12px; background:#fafafa; border:1px solid #f3f4f6; border-radius:10px; }
    .order .meta { color:var(--muted); font-size:13px; }
    .small-muted { color:var(--muted); font-size:13px; }

    .field-row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:640px){ .field-row{ grid-template-columns:1fr } }

    .center-row { display:flex; gap:8px; align-items:center; }
    .btn-outline { background:#fff; border:1px solid #eee; color:var(--dark-color); padding:8px 12px; border-radius:10px; cursor:pointer; }
  </style>
</head>
<body>

  <header class="header">
    <div class="container">
      <div class="logo">Best<span>Food</span></div>
      <nav class="nav" id="nav">
        <a href="index.html">Trang chủ</a>
        <a href="menu.html">Thực đơn</a>
        <a href="cart.html">Giỏ hàng</a>
        <a href="about_us.html">Giới thiệu</a>
        <a href="contact.html">Liên hệ</a>
        <a href="booking.html">Đặt món online</a>
        <a href="login.html" id="goLogin">Đăng nhập</a>
        <a href="register.html" id="goRegister">Đăng ký</a>
      </nav>
    </div>
  </header>

  <main class="account-wrap">
    <div class="account-grid">
      <!-- SIDEBAR -->
      <aside class="sidebar" role="navigation" aria-label="Chức năng tài khoản">
        <div class="user">
          <img id="sideAvatar" class="avatar-sm" src="https://i.pravatar.cc/150?img=7" alt="avatar">
          <div>
            <div id="sideName" style="font-weight:800">Khách</div>
            <div id="sidePhone" class="small-muted">—</div>
          </div>
        </div>

        <nav id="accountNav" style="display:flex; flex-direction:column; gap:6px; margin-top:12px;">
          <button class="nav-item active" data-view="profile"><i class="fas fa-user"></i> Thông tin cá nhân</button>
          <button class="nav-item" data-view="orders"><i class="fas fa-receipt"></i> Đơn hàng</button>
          <button class="nav-item" data-view="addresses"><i class="fas fa-map-marker-alt"></i> Địa chỉ</button>
          <button class="nav-item" data-view="payments"><i class="fas fa-credit-card"></i> Phương thức thanh toán</button>
          <button class="nav-item" data-view="password"><i class="fas fa-lock"></i> Đổi mật khẩu</button>
          <hr style="border:none;border-top:1px solid #f3f4f6;margin:8px 0">
          <a id="logoutBtn" class="nav-item" href="#"><i class="fas fa-sign-out-alt" style="color:#e74c3c"></i> Đăng xuất</a>
        </nav>
      </aside>

      <!-- MAIN PANEL -->
      <section>
        <!-- PROFILE VIEW -->
        <div id="view-profile" class="panel view">
          <h3>Thông tin cá nhân</h3>
          <div style="margin-top:12px; display:grid; gap:12px;">
            <div class="profile-row">
              <img id="profileAvatar" class="thumb" src="https://i.pravatar.cc/300?img=7" alt="avatar">
              <div style="flex:1">
                <form id="profileForm">
                  <div class="field-row">
                    <div class="group">
                      <label>Họ và tên</label>
                      <input id="fullName" type="text" placeholder="Nguyễn Văn A" required>
                      <small class="err" data-err="fullName"></small>
                    </div>
                    <div class="group">
                      <label>Số điện thoại</label>
                      <input id="phone" type="tel" placeholder="0912345678" required>
                      <small class="err" data-err="phone"></small>
                    </div>
                  </div>

                  <div class="group">
                    <label>Địa chỉ</label>
                    <input id="address" type="text" placeholder="Số nhà, đường, quận/huyện, tỉnh/thành">
                  </div>

                  <div class="field-row">
                    <div class="group">
                      <label>Ngày sinh</label>
                      <input id="dob" type="date">
                    </div>
                    <div class="group">
                      <label>Ảnh đại diện</label>
                      <input id="avatarFile" type="file" accept="image/*">
                    </div>
                  </div>

                  <div style="display:flex;gap:10px;margin-top:8px">
                    <button id="saveProfile" class="btn" type="submit">Lưu thay đổi</button>
                    <button id="cancelProfile" class="btn-outline" type="button">Huỷ</button>
                  </div>
                  <div id="profileOk" class="ok" style="margin-top:10px;display:none"></div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- ORDERS VIEW -->
        <div id="view-orders" class="panel view" style="display:none">
          <h3>Đơn hàng của tôi</h3>
          <div style="margin-top:12px">
            <div id="ordersArea" class="orders-list">
              <div class="muted">Đang tải đơn hàng…</div>
            </div>
          </div>
        </div>

        <!-- ADDRESSES VIEW -->
        <div id="view-addresses" class="panel view" style="display:none">
          <h3>Địa chỉ</h3>
          <p class="small-muted">Quản lý địa chỉ giao hàng thường dùng.</p>
          <div style="margin-top:12px" id="addressesList"></div>

          <form id="addressForm" style="margin-top:12px">
            <div class="group">
              <label>Địa chỉ mới</label>
              <input id="newAddress" type="text" placeholder="Số nhà, đường, quận/huyện, tỉnh/thành" required>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" type="submit">Thêm địa chỉ</button>
              <button id="clearAddresses" type="button" class="btn-outline">Xoá tất cả</button>
            </div>
          </form>
        </div>

        <!-- PAYMENTS VIEW -->
        <div id="view-payments" class="panel view" style="display:none">
          <h3>Phương thức thanh toán</h3>
          <div id="paymentsList" style="margin-top:12px"></div>
        </div>

        <!-- PASSWORD VIEW -->
        <div id="view-password" class="panel view" style="display:none">
          <h3>Đổi mật khẩu</h3>
          <form id="pwForm" style="margin-top:12px">
            <div class="group">
              <label>Mật khẩu hiện tại</label>
              <input id="currentPw" type="password" placeholder="Mật khẩu hiện tại">
            </div>
            <div class="group">
              <label>Mật khẩu mới</label>
              <input id="newPw" type="password" placeholder="Tối thiểu 6 ký tự">
            </div>
            <div class="group">
              <label>Xác nhận mật khẩu mới</label>
              <input id="newPw2" type="password" placeholder="Nhập lại mật khẩu">
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" type="submit">Cập nhật mật khẩu</button>
              <button id="cancelPw" type="button" class="btn-outline">Huỷ</button>
            </div>
            <div id="pwMsg" class="ok" style="margin-top:10px;display:none"></div>
          </form>
        </div>

      </section>
    </div>
  </main>

  <footer>© 2025 BestFood</footer>

  <!-- Script: logic giống pattern các trang khác (token, user từ localStorage) -->
  <script>
    (function(){
      const TOKEN_KEY = 'bestfood_token';
      const USER_KEY  = 'currentUser';
      const STORAGE_CART = 'bestfood_cart';
      const LAST_ORDER = 'bestfood_last_order';

      // Helpers
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const showView = (id) => {
        $$('.view').forEach(v => v.style.display = v.id === id ? '' : 'none');
        $$('#accountNav .nav-item').forEach(b => b.classList.toggle('active', b.dataset.view === id.replace('view-','')));
      };

      function safeParse(v, fallback){ try { return JSON.parse(v || 'null') || fallback; } catch { return fallback; } }

      // Nav setup
      const navButtons = Array.from(document.querySelectorAll('#accountNav .nav-item'));
      navButtons.forEach(btn => btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        showView('view-' + view);
      }));

      // Logout
      $('#logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem(TOKEN_KEY);
        // keep currentUser? usually remove
        localStorage.removeItem(USER_KEY);
        location.href = 'index.html';
      });

      // Prefill user info
      const token = localStorage.getItem(TOKEN_KEY);
      const user = safeParse(localStorage.getItem(USER_KEY), {});
      if(user && (user.name || user.phone || user.avatar)){
        $('#sideName').textContent = user.name || (user.phone || 'Khách');
        $('#sidePhone').textContent = user.phone || '';
        $('#sideAvatar').src = user.avatar || $('#sideAvatar').src;
        $('#profileAvatar').src = user.avatar || $('#profileAvatar').src;
        $('#fullName').value = user.name || '';
        $('#phone').value = user.phone || '';
        $('#address').value = user.address || '';
        if(user.dob) $('#dob').value = user.dob;
      }

      // Avatar preview -> update img tag
      $('#avatarFile').addEventListener('change', (ev)=>{
        const f = ev.target.files?.[0];
        if(!f) return;
        $('#profileAvatar').src = URL.createObjectURL(f);
        $('#sideAvatar').src = $('#profileAvatar').src;
      });

      // Save profile (demo: save to localStorage; in real: call API)
      $('#profileForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = $('#fullName').value.trim();
        const phone = $('#phone').value.trim();
        const addr = $('#address').value.trim();
        const dob = $('#dob').value || '';
        if(!name || !phone){ alert('Vui lòng nhập họ tên và số điện thoại'); return; }

        // avatar: if file chosen, store object URL (demo only) or base64
        const f = $('#avatarFile').files?.[0];
        if(f){
          const reader = new FileReader();
          reader.onload = function(ev){
            const avatarData = ev.target.result;
            saveProfile({ name, phone, address: addr, dob, avatar: avatarData });
          };
          reader.readAsDataURL(f);
        } else {
          saveProfile({ name, phone, address: addr, dob, avatar: $('#profileAvatar').src });
        }
      });

      function saveProfile(obj){
        // merge with existing
        const cur = safeParse(localStorage.getItem(USER_KEY), {});
        const merged = Object.assign({}, cur, obj);
        localStorage.setItem(USER_KEY, JSON.stringify(merged));
        $('#sideName').textContent = merged.name || merged.phone || 'Khách';
        $('#profileOk').textContent = 'Lưu thông tin thành công!';
        $('#profileOk').style.display = 'block';
        setTimeout(()=> $('#profileOk').style.display = 'none', 2200);
      }

      // Orders: read from LAST_ORDER (demo) or call API
      function renderOrders(){
        const area = $('#ordersArea');
        area.innerHTML = '';
        // Try server fetch first (if token) — demo: we use localStorage fallback
        // localStorage 'bestfood_last_order' may hold single last order (demo), or you can store array 'bestfood_orders'
        const orders = safeParse(localStorage.getItem('bestfood_orders'), null) || (localStorage.getItem(LAST_ORDER) ? [ safeParse(localStorage.getItem(LAST_ORDER), {}) ] : []);
        if(!orders || orders.length === 0){
          area.innerHTML = `<div class="muted">Chưa có đơn hàng nào.</div>`;
          return;
        }
        orders.forEach(o => {
          const created = o.created_at ? (new Date(o.created_at)).toLocaleString() : '';
          const totals = o.totals ? (Number(o.totals.grand||0)).toLocaleString('vi-VN') + ' đ' : (o.totals ? (Number(o.totals.grand)||0) : 0);
          const items = Array.isArray(o.items) ? o.items.map(i => `${i.qty}×${i.name}`).join(' · ') : '';
          const html = document.createElement('div');
          html.className = 'order';
          html.innerHTML = `
            <div>
              <div style="font-weight:800">Mã đơn: ${o.id || '—'}</div>
              <div class="meta">${created} • ${items}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:800">${typeof totals === 'string' ? totals : (Number(totals)||0) + ' đ'}</div>
              <div class="small-muted" style="margin-top:8px">
                <button class="btn-sm" onclick="viewOrder('${o.id||''}')">Xem chi tiết</button>
              </div>
            </div>
          `;
          area.appendChild(html);
        });
      }

      // expose function for inline handler
      window.viewOrder = function(id){
        alert('Xem chi tiết đơn (demo). Mã: ' + id + '\n(Ở thực tế gọi API /orders/:id để lấy chi tiết).');
      };

      // Addresses
      function renderAddresses(){
        const list = $('#addressesList');
        const arr = safeParse(localStorage.getItem('bf_addresses'), []);
        if(!arr.length){
          list.innerHTML = `<div class="muted">Chưa có địa chỉ nào.</div>`;
        } else {
          list.innerHTML = arr.map((a, idx) => `
            <div class="item" style="display:flex;justify-content:space-between;align-items:center">
              <div style="max-width:80%">${escapeHtml(a)}</div>
              <div style="display:flex;gap:8px">
                <button class="btn-sm" onclick="editAddress(${idx})">Sửa</button>
                <button class="btn-sm" onclick="delAddress(${idx})">Xoá</button>
              </div>
            </div>
          `).join('');
        }
      }
      window.editAddress = function(i){
        const arr = safeParse(localStorage.getItem('bf_addresses'), []);
        const v = prompt('Sửa địa chỉ', arr[i] || '');
        if(v !== null){ arr[i] = v.trim(); localStorage.setItem('bf_addresses', JSON.stringify(arr)); renderAddresses(); }
      };
      window.delAddress = function(i){
        if(!confirm('Xoá địa chỉ này?')) return;
        const arr = safeParse(localStorage.getItem('bf_addresses'), []);
        arr.splice(i,1);
        localStorage.setItem('bf_addresses', JSON.stringify(arr));
        renderAddresses();
      };
      $('#addressForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const v = $('#newAddress').value.trim();
        if(!v) return alert('Nhập địa chỉ');
        const arr = safeParse(localStorage.getItem('bf_addresses'), []);
        arr.push(v);
        localStorage.setItem('bf_addresses', JSON.stringify(arr));
        $('#newAddress').value = '';
        renderAddresses();
      });
      $('#clearAddresses').addEventListener('click', ()=>{ if(confirm('Xoá tất cả địa chỉ?')){ localStorage.removeItem('bf_addresses'); renderAddresses(); } });

      // Payments (demo)
      function renderPayments(){
        const area = $('#paymentsList');
        const arr = safeParse(localStorage.getItem('bf_payments'), []);
        if(!arr.length) area.innerHTML = `<div class="muted">Chưa lưu phương thức thanh toán.</div>`;
        else area.innerHTML = arr.map((p, idx) => `
          <div class="item" style="display:flex;justify-content:space-between;align-items:center">
            <div><b>${escapeHtml(p.type || 'Thẻ')}</b> • ${maskCard(p.card || '')} <div class="small-muted">${escapeHtml(p.note || '')}</div></div>
            <div style="display:flex;gap:8px">
              <button class="btn-sm" onclick="delPayment(${idx})">Xoá</button>
            </div>
          </div>
        `).join('');
      }
      function maskCard(s=''){ if(!s) return ''; return '•••• •••• •••• ' + s.slice(-4); }
      window.delPayment = function(i){ if(!confirm('Xoá phương thức này?')) return; const arr = safeParse(localStorage.getItem('bf_payments'), []); arr.splice(i,1); localStorage.setItem('bf_payments', JSON.stringify(arr)); renderPayments(); };

      // Password (demo): just front validation — real change via API
      $('#pwForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const cur = $('#currentPw').value;
        const n = $('#newPw').value;
        const n2 = $('#newPw2').value;
        if(n.length < 6){ alert('Mật khẩu mới tối thiểu 6 ký tự'); return; }
        if(n !== n2){ alert('Mật khẩu nhập lại không khớp'); return; }
        // Demo: just show success
        $('#pwMsg').textContent = 'Cập nhật mật khẩu thành công (demo).';
        $('#pwMsg').style.display = 'block';
        setTimeout(()=> $('#pwMsg').style.display = 'none', 2200);
        $('#currentPw').value = $('#newPw').value = $('#newPw2').value = '';
      });

      // small util
      function escapeHtml(s=''){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      // Init
      showView('view-profile');
      renderOrders();
      renderAddresses();
      renderPayments();

      // If user not logged in, show gentle guard (reuse pattern)
      if(!localStorage.getItem(TOKEN_KEY)){
        // show a banner and optionally redirect to login
        const guard = document.createElement('div');
        guard.className = 'login-guard';
        guard.innerHTML = `Bạn chưa đăng nhập. Vui lòng <a href="login.html">đăng nhập</a> để quản lý tài khoản.`;
        document.querySelector('.account-wrap').prepend(guard);
      }

    })();
  </script>

</body>
</html>
