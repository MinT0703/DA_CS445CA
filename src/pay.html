<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thanh Toán - BestFood</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="./style.css">
    <style>
      /* page-specific */
      .checkout-grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:18px; max-width:1200px; margin:22px auto; padding:0 20px; }
      @media(max-width:900px){ .checkout-grid{ grid-template-columns:1fr } }
      .card-panel{ background:#fff; border-radius:12px; padding:16px; box-shadow:var(--shadow); }
      .pm-extra{ margin-top:12px; padding:12px; border-radius:10px; background:#fff7f3; border:1px dashed #f5c2b4; }
      .qr-box{ display:flex; gap:12px; align-items:center; }
      .qr-box img{ width:140px; height:140px; object-fit:cover; border-radius:8px; border:1px solid #eee; }
      .small-muted{ color:var(--muted); font-size:13px; }
      .method-title{ font-weight:700; }
      .payment-method { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border:1px solid #eee; border-radius:10px; cursor:pointer; background:#fff; margin-bottom:8px; }
      .payment-method input[type="radio"]{ margin:0 12px 0 0; width:18px; height:18px; }
      .card-inputs input{ width:100%; padding:10px; margin:6px 0; border-radius:8px; border:1px solid #ddd; }
      .muted-small{ color:var(--muted); font-size:13px; }
    </style>
  </head>
  <body>
    <!-- header (same as other pages) -->
    <header class="header">
      <div class="container">
        <div class="logo">Best<span>Food</span></div>
        <nav class="nav" id="nav">
          <a href="index.html">Trang chủ</a>
          <a href="menu.html">Thực đơn</a>
          <a href="cart.html">Giỏ hàng</a>
          <a href="about_us.html">Giới thiệu</a>
          <a href="contact.html">Liên hệ</a>
          <a href="booking.html">Đặt món online</a>
          <a href="login.html" id="goLogin">Đăng nhập</a>
          <a href="register.html" id="goRegister">Đăng ký</a>
        </nav>
        <div class="mobile-menu" id="mobileMenu" aria-label="menu"><i class="fas fa-bars"></i></div>
      </div>
    </header>

    <main class="checkout-grid">
      <!-- left: form -->
      <section class="card-panel">
        <h2>Thanh toán & đặt món</h2>
        <p class="muted">Kiểm tra giỏ hàng, chọn phương thức nhận hàng và thanh toán ngay trên web.</p>

        <div style="margin-top:12px">
          <label style="display:block;margin-bottom:6px;font-weight:700">Hình thức nhận</label>
          <select id="fulfillment" style="padding:10px;border-radius:8px;border:1px solid #ddd;width:100%">
            <option value="delivery">Giao tận nơi</option>
            <option value="pickup">Mang về</option>
            <option value="dinein">Tại quán (đặt bàn)</option>
          </select>
          <div id="dineinHint" class="small-muted" style="margin-top:8px;display:none">
            Bạn chọn "Tại quán" — nếu cần giữ bàn, <a href="booking.html">vào trang đặt bàn</a> hoặc chọn bàn tại bước sau.
          </div>
        </div>

        <hr style="margin:16px 0">

        <h3>Thông tin liên hệ & giao nhận</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <input id="firstName" placeholder="Họ" />
          <input id="lastName" placeholder="Tên" />
        </div>
        <div style="margin-top:10px">
          <input id="phone" placeholder="Số điện thoại" />
        </div>
        <div style="margin-top:10px">
          <input id="email" placeholder="Email (tùy chọn)" />
        </div>
        <div style="margin-top:10px">
          <input id="address" placeholder="Địa chỉ giao (để trống nếu tại quán/mang về)" />
        </div>

        <hr style="margin:16px 0">

        <h3>Phương thức thanh toán</h3>

        <div id="pmList">
          <label class="payment-method" data-value="cod">
            <div style="display:flex;align-items:center;gap:12px">
              <input type="radio" name="payment" value="cod" checked />
              <div>
                <div class="method-title">Thanh toán khi nhận hàng (COD)</div>
                <div class="small-muted">Thanh toán trực tiếp cho nhân viên giao/thu ngân</div>
              </div>
            </div>
            <div class="pm-icon"><i class="fas fa-money-bill"></i></div>
          </label>

          <label class="payment-method" data-value="bank">
            <div style="display:flex;align-items:center;gap:12px">
              <input type="radio" name="payment" value="bank" />
              <div>
                <div class="method-title">Chuyển khoản ngân hàng</div>
                <div class="small-muted">Chuyển trước, ghi rõ mã đơn</div>
              </div>
            </div>
            <div class="pm-icon"><i class="fas fa-university"></i></div>
          </label>

          <label class="payment-method" data-value="momo">
            <div style="display:flex;align-items:center;gap:12px">
              <input type="radio" name="payment" value="momo" />
              <div>
                <div class="method-title">Ví MoMo</div>
                <div class="small-muted">Quét QR hoặc mở ví thanh toán</div>
              </div>
            </div>
            <div class="pm-icon"><i class="fas fa-mobile-alt"></i></div>
          </label>

          <label class="payment-method" data-value="card">
            <div style="display:flex;align-items:center;gap:12px">
              <input type="radio" name="payment" value="card" />
              <div>
                <div class="method-title">Thẻ tín dụng / ghi nợ</div>
                <div class="small-muted">Visa, MasterCard, JCB...</div>
              </div>
            </div>
            <div class="pm-icon"><i class="fas fa-credit-card"></i></div>
          </label>
        </div>

        <!-- dynamic extra UI for methods -->
        <div id="pmExtra" class="pm-extra" style="display:none"></div>

        <div style="margin-top:14px">
          <label>Ghi chú cho nhà bếp (tuỳ chọn)</label>
          <textarea id="notes" rows="3" placeholder="Ví dụ: không hành, bỏ ớt..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd"></textarea>
        </div>

        <div style="margin-top:16px;display:flex;gap:12px">
          <button id="placeOrder" class="btn" style="flex:1">Thanh toán & đặt hàng</button>
        </div>

      </section>

      <!-- right: order summary -->
      <aside class="card-panel">
        <h3>Đơn hàng</h3>
        <div id="cartList" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <div style="display:flex;justify-content:space-between"><div>Tạm tính</div><div id="subTotal">0 đ</div></div>
          <div style="display:flex;justify-content:space-between"><div>Phí</div><div id="shipFee">0 đ</div></div>
          <div style="display:flex;justify-content:space-between"><div>Giảm</div><div id="discount">0 đ</div></div>
          <hr style="margin:12px 0" />
          <div style="display:flex;justify-content:space-between;font-weight:800;font-size:18px"><div>Tổng</div><div id="grandTotal">0 đ</div></div>
        </div>

        <div style="margin-top:12px">
          <button id="editCart" class="btn btn-sm" style="width:100%;background:#fff;color:var(--primary);border:1px solid #f3c2bd">Chỉnh sửa giỏ</button>
        </div>
      </aside>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-bottom">© 2025 BestFood</div>
      </div>
    </footer>

    <script>

    (function(){
      const CART_KEY = 'bestfood_cart';
      const currency = v => (Number(v)||0).toLocaleString('vi-VN') + ' đ';

      function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { return []; } }
      function calcTotals(cart){
        const sub = cart.reduce((s,it)=> s + (Number(it.price)||0) * (Number(it.qty)||0), 0);
        const ship = sub >= 500000 ? 0 : (sub ? 20000 : 0);
        const discount = Number(localStorage.getItem('bestfood_coupon_discount')||0);
        const grand = Math.max(0, sub + ship - discount);
        return { sub, ship, discount, grand };
      }

      function renderCart(){
        const cart = loadCart();
        const el = document.getElementById('cartList');
        if(!cart.length){
          el.innerHTML = '<div class="muted">Giỏ hàng trống — <a href="menu.html">vào thực đơn</a></div>';
        } else {
          el.innerHTML = cart.map(it => `
            <div style="display:flex;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid #f3f4f6">
              <img src="${it.image||'https://picsum.photos/200'}" style="width:72px;height:56px;object-fit:cover;border-radius:8px" />
              <div style="flex:1">
                <div style="font-weight:700">${it.name}</div>
                <div class="muted-small">x${it.qty} • ${it.unit||''}</div>
              </div>
              <div style="font-weight:800">${currency((Number(it.price)||0)*(Number(it.qty)||1))}</div>
            </div>
          `).join('');
        }
        const t = calcTotals(cart);
        document.getElementById('subTotal').textContent = currency(t.sub);
        document.getElementById('shipFee').textContent = currency(t.ship);
        document.getElementById('discount').textContent = currency(t.discount);
        document.getElementById('grandTotal').textContent = currency(t.grand);
      }

      // payment method extras
      const pmExtra = document.getElementById('pmExtra');
      function showExtraFor(method){
        pmExtra.style.display = 'none';
        pmExtra.innerHTML = '';
        if(method === 'bank'){
          pmExtra.style.display = 'block';
          pmExtra.innerHTML = `
            <div style="font-weight:700">Thông tin chuyển khoản</div>
            <div class="small-muted" style="margin-top:6px">Ngân hàng: Vietcombank - Chi nhánh HCM<br>Chủ tài khoản: BestFood JSC<br>Số tài khoản: 0123456789</div>
            <div style="margin-top:10px">
              <button id="iPaid" class="btn btn-sm">Tôi đã chuyển khoản</button>
            </div>
            <div class="small-muted" style="margin-top:8px">Lưu ý: ghi mã đơn ở phần nội dung chuyển khoản để xác nhận tự động.</div>
          `;
          document.getElementById('iPaid').addEventListener('click', ()=> {
            alert('Cảm ơn — hệ thống sẽ đánh dấu đơn là "đang chờ xác nhận chuyển khoản". (Demo)');
            // in thực tế: gọi API để mark order.status = pending_bank
            placeOrder({ skipConfirm: true, paymentMock: 'bank_confirmed' });
          });
        } else if(method === 'momo'){
          pmExtra.style.display = 'block';
          pmExtra.innerHTML = `
            <div style="font-weight:700">Thanh toán qua MoMo</div>
            <div class="qr-box" style="margin-top:8px">
              <img src="https://via.placeholder.com/300x300.png?text=QR+MoMo" alt="QR MoMo" />
              <div>
                <div class="small-muted">Quét QR hoặc bấm "Mở MoMo" để thanh toán.</div>
                <div style="margin-top:10px">
                  <button id="openMomo" class="btn btn-sm">Mở MoMo (mock)</button>
                  <button id="checkMomo" class="btn btn-sm" style="background:#fff;color:var(--primary);border:1px solid #f3c2bd">Kiểm tra trạng thái</button>
                </div>
              </div>
            </div>
          `;
          document.getElementById('openMomo').addEventListener('click', ()=> alert('Mở MoMo (demo) — thay bằng deep link hoặc API thực tế.'));
          document.getElementById('checkMomo').addEventListener('click', ()=> {
            // mock success
            alert('Thanh toán MoMo được xác nhận (demo). Hệ thống sẽ tiếp tục xử lý đơn.');
            placeOrder({ paymentMock: 'momo_success' });
          });
        } else if(method === 'card'){
          pmExtra.style.display = 'block';
          pmExtra.innerHTML = `
            <div style="font-weight:700">Nhập thông tin thẻ</div>
            <div class="card-inputs" style="margin-top:8px">
              <input id="cardNumber" placeholder="Số thẻ (xxxx xxxx xxxx xxxx)" />
              <div style="display:flex;gap:8px;">
                <input id="cardExp" placeholder="MM/YY" style="flex:1" />
                <input id="cardCVC" placeholder="CVC" style="width:100px" />
              </div>
              <input id="cardName" placeholder="Tên in trên thẻ" />
              <div style="margin-top:8px; display:flex; gap:8px;">
                <button id="payCard" class="btn btn-sm">Thanh toán bằng thẻ (demo)</button>
              </div>
            </div>
            <div class="small-muted" style="margin-top:8px">Lưu ý: trang này dùng demo. Để tích hợp thật, gửi token hóa thẻ từ gateway (Stripe/VNPAY/…)</div>
          `;
          document.getElementById('payCard').addEventListener('click', ()=> {
            const num = document.getElementById('cardNumber').value.replace(/\s+/g,'');
            const exp = document.getElementById('cardExp').value.trim();
            const cvc = document.getElementById('cardCVC').value.trim();
            const name = document.getElementById('cardName').value.trim();
            if(!num||!exp||!cvc||!name){ alert('Vui lòng nhập đủ thông tin thẻ'); return; }
            if(!luhnCheck(num)){ alert('Số thẻ không hợp lệ (demo)'); return; }
            // mock tokenization
            const token = 'cardtok_' + Date.now();
            alert('Thanh toán thành công (demo). Token: ' + token);
            placeOrder({ paymentMock: 'card_token:'+token });
          });
        } else {
          // cod -> nothing
        }
      }

      // Luhn algorithm for basic card validation
      function luhnCheck(num){
        let s = 0, dbl = false;
        for(let i = num.length - 1; i >= 0; i--){
          let d = parseInt(num[i],10);
          if(isNaN(d)) return false;
          if(dbl){ d = d*2; if(d>9) d -=9; }
          s += d; dbl = !dbl;
        }
        return s % 10 === 0;
      }

      // click listeners: selecting payment method area
      document.getElementById('pmList').addEventListener('click', (e)=>{
        const label = e.target.closest('.payment-method');
        if(!label) return;
        const method = label.dataset.value;
        // set radio
        document.querySelectorAll('input[name="payment"]').forEach(r=> r.checked = (r.value === method));
        showExtraFor(method);
      });

      // also change when radios clicked directly
      document.querySelectorAll('input[name="payment"]').forEach(r=>{
        r.addEventListener('change', ()=> showExtraFor(r.value));
      });

      // fulfillment change
      document.getElementById('fulfillment').addEventListener('change', (e)=>{
        const v = e.target.value;
        document.getElementById('dineinHint').style.display = (v === 'dinein') ? 'block' : 'none';
      });

      // edit cart
      document.getElementById('editCart').addEventListener('click', ()=> location.href = 'cart.html');

      // save for later
      document.getElementById('saveForLater').addEventListener('click', ()=>{
        const snapshot = {
          cart: loadCart(),
          saved_at: new Date().toISOString()
        };
        localStorage.setItem('bestfood_saved_cart', JSON.stringify(snapshot));
        alert('Đã lưu tạm giỏ hàng. Bạn có thể phục hồi từ trang Giỏ hàng.');
      });

      // place order action (client side)
      document.getElementById('placeOrder').addEventListener('click', ()=> placeOrder({}) );

      function placeOrder(opts = {}){
        const cart = loadCart();
        if(!cart.length){ alert('Giỏ hàng trống'); return; }
        // validate contact fields
        const fn = document.getElementById('firstName').value.trim();
        const ln = document.getElementById('lastName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const email = document.getElementById('email').value.trim();
        const notes = document.getElementById('notes').value.trim();
        const fulfillment = document.getElementById('fulfillment').value;
        const payment = document.querySelector('input[name="payment"]:checked').value;

        if(!fn || !ln || !phone){ alert('Vui lòng nhập Họ, Tên và Số điện thoại.'); return; }
        if(fulfillment === 'delivery' && !address){ if(!confirm('Bạn chưa nhập địa chỉ giao — tiếp tục?')) return; }

        const totals = calcTotals(cart);
        const order = {
          id: 'ORD-' + Date.now(),
          customer: { firstName: fn, lastName: ln, phone, email, address },
          fulfillment,
          payment,
          items: cart,
          totals,
          notes,
          created_at: new Date().toISOString(),
          meta: { mock: opts.paymentMock || null }
        };

        // If opts.skipConfirm === true, we already confirmed (ex: bank "I paid")
        // In real integration: replace following localStorage save with fetch POST to your backend:
        // fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order) })
        //   .then(...).catch(...)
        localStorage.setItem('bestfood_last_order', JSON.stringify(order));
        // If payment was processed (card/momo mock), clear cart; if bank pending, you may keep cart depending on flow
        if(payment !== 'bank') localStorage.removeItem(CART_KEY);
        localStorage.removeItem('bestfood_coupon_discount');

        // demo success UX
        alert('Đặt hàng thành công! Mã: ' + order.id);
        // redirect to order success page (you can implement order-success.html to read bestfood_last_order)
        location.href = 'index.html';
      }

      // init render
      renderCart();
      // show extra for default choice (cod)
      showExtraFor(document.querySelector('input[name="payment"]:checked').value);

      // keep in sync if cart modified in other tab
      window.addEventListener('storage', (e)=>{
        if(e.key === CART_KEY || e.key === 'bestfood_coupon_discount') renderCart();
      });

    })();
    </script>

  </body>
</html>
