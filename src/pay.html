<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thanh Toán - BestFood</title>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Project global styles -->
    <link rel="stylesheet" href="./style.css">

    <!-- Page-specific small styles (keeps most styling in style.css) -->
    <style>
      .checkout-hero{
        background: linear-gradient( rgba(0,0,0,.15), rgba(0,0,0,.15) ),
                    url("https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1350&q=80") center/cover no-repeat;
        color: #fff;
        padding: 56px 20px;
        text-align: center;
      }

      .checkout-grid {
        display: grid;
        grid-template-columns: 1.2fr .8fr;
        gap: 18px;
        max-width: 1200px;
        margin: 18px auto;
        padding: 0 20px 40px;
      }

      .card-panel { background:#fff; border-radius:12px; padding:18px; box-shadow:var(--shadow); }
      .form-row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
      @media(max-width:900px){ .checkout-grid{ grid-template-columns:1fr } .form-row{ grid-template-columns:1fr } }

      .payment-method { display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #eee; border-radius:10px; cursor:pointer; }
      .payment-method input { margin-right:8px; accent-color: var(--primary); }

      .order-summary { position:sticky; top:96px; }
      .cart-item{ display:flex; gap:12px; padding:12px 0; border-bottom:1px solid #f3f4f6; align-items:center; }
      .cart-item img{ width:72px; height:56px; object-fit:cover; border-radius:8px; }

      .btn-wide { width:100%; padding:12px 16px; border-radius:12px; font-weight:700; }
    </style>
  </head>
  <body>

    <!-- Header (consistent with project) -->
    <header class="header">
      <div class="container">
        <div class="logo">Best<span>Food</span></div>
        <nav class="nav" id="nav">
          <a href="index.html">Trang chủ</a>
          <a href="menu.html">Thực đơn</a>
          <a href="cart.html">Giỏ hàng</a>
          <a href="about_us.html">Giới thiệu</a>
          <a href="contact.html">Liên hệ</a>
          <a href="booking.html">Đặt món online</a>
          <a href="login.html">Đăng nhập</a>
          <a href="register.html">Đăng ký</a>
        </nav>
        <div class="mobile-menu" id="mobileMenu" aria-label="menu"><i class="fas fa-bars"></i></div>
      </div>
    </header>

    <!-- Hero -->
    <section class="checkout-hero">
      <div class="container">
        <h1>Thanh toán</h1>
        <p class="muted">Kiểm tra thông tin giao hàng và chọn phương thức thanh toán.</p>
      </div>
    </section>

    <!-- Main checkout -->
    <main class="checkout-grid">
      <!-- Left: form -->
      <section class="card-panel">
        <h3>Thông tin giao hàng</h3>

        <form id="checkoutForm">
          <div class="form-row" style="margin-top:12px">
            <div>
              <label>Họ</label>
              <input id="firstName" type="text" placeholder="Nguyễn" required>
            </div>
            <div>
              <label>Tên</label>
              <input id="lastName" type="text" placeholder="Văn A" required>
            </div>
          </div>

          <div class="form-row" style="margin-top:12px">
            <div>
              <label>Số điện thoại</label>
              <input id="phone" type="tel" placeholder="0912345678" required>
            </div>
            <div>
              <label>Email</label>
              <input id="email" type="email" placeholder="example@you.com">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Địa chỉ</label>
            <input id="address" type="text" placeholder="Số nhà, tên đường, quận/huyện" required>
          </div>

          <div class="form-row" style="margin-top:12px">
            <div>
              <label>Thành phố</label>
              <select id="city">
                <option value="">Chọn thành phố</option>
                <option value="hcm">TP. Hồ Chí Minh</option>
                <option value="hn">Hà Nội</option>
                <option value="dn">Đà Nẵng</option>
                <option value="other">Khác</option>
              </select>
            </div>
            <div>
              <label>Quận/Huyện</label>
              <input id="district" type="text" placeholder="Ví dụ: Quận 1">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Ghi chú (tuỳ chọn)</label>
            <textarea id="notes" rows="3" placeholder="Ví dụ: cổng sau, kêu ở tầng 2..."></textarea>
          </div>

          <hr style="margin:18px 0">

          <h3>Phương thức thanh toán</h3>
          <!-- Thanh toán khi nhận hàng -->
<label class="payment-method">
  <div style="display:flex; align-items:center; gap:12px;">
    <input type="radio" name="payment" value="cod" checked>
    <div class="pm-text">
      <span class="method-title">Thanh toán khi nhận hàng (COD)</span>
      <small class="muted-small">Thanh toán trực tiếp khi giao hàng</small>
    </div>
  </div>
  <div class="pm-icon">
    <i class="fas fa-money-bill"></i>
  </div>
</label>

<!-- Chuyển khoản ngân hàng -->
<label class="payment-method">
  <div style="display:flex; align-items:center; gap:12px;">
    <input type="radio" name="payment" value="bank">
    <div class="pm-text">
      <span class="method-title">Chuyển khoản ngân hàng</span>
      <small class="muted-small">Thanh toán qua tài khoản ngân hàng</small>
    </div>
  </div>
  <div class="pm-icon">
    <i class="fas fa-university"></i>
  </div>
</label>

<!-- Ví MoMo -->
<label class="payment-method">
  <div style="display:flex; align-items:center; gap:12px;">
    <input type="radio" name="payment" value="momo">
    <div class="pm-text">
      <span class="method-title">Ví MoMo</span>
      <small class="muted-small">Thanh toán nhanh qua ví MoMo</small>
    </div>
  </div>
  <div class="pm-icon">
    <i class="fas fa-mobile-alt"></i>
  </div>
</label>

<!-- Thẻ tín dụng / ghi nợ -->
<label class="payment-method">
  <div style="display:flex; align-items:center; gap:12px;">
    <input type="radio" name="payment" value="card">
    <div class="pm-text">
      <span class="method-title">Thẻ tín dụng / ghi nợ</span>
      <small class="muted-small">Visa, MasterCard, JCB…</small>
    </div>
  </div>
  <div class="pm-icon">
    <i class="fas fa-credit-card"></i>
  </div>
</label>


          <div style="margin-top:18px" class="row">
            <button type="button" id="placeOrder" class="btn btn-wide" style="background:var(--primary);color:#fff">Đặt hàng</button>
          </div>
        </form>
      </section>

      <!-- Right: order summary -->
      <aside class="card-panel order-summary">
        <h3>Đơn hàng của bạn</h3>

        <div id="cartList" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <input id="coupon" placeholder="Mã giảm giá (nếu có)" style="width:100%; padding:10px; border-radius:8px; border:1px solid #eee" />
          <div style="display:flex; gap:8px; margin-top:8px">
            <button id="applyCoupon" class="btn btn-sm" style="flex:1">Áp dụng</button>
            <button id="goCart" class="btn btn-sm" style="flex:1; background:#f3f4f6; color:var(--dark-color)">Chỉnh sửa giỏ</button>
          </div>
        </div>

        <div style="margin-top:14px; border-top:1px solid #f3f4f6; padding-top:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Tạm tính</span><span id="subTotal">0 đ</span></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Phí vận chuyển</span><span id="shipFee">0 đ</span></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Giảm giá</span><span id="discount">0 đ</span></div>
          <div style="display:flex;justify-content:space-between;font-weight:800;font-size:18px;margin-top:10px"><span>Tổng cộng</span><span id="grandTotal">0 đ</span></div>
        </div>
      </aside>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-column">
            <h3>BestFood</h3>
            <p>Phục vụ đam mê ẩm thực từ 2010. Mọi quyền được bảo lưu.</p>
          </div>
          <div class="footer-column">
            <h3>Liên kết</h3>
            <ul>
              <li><a href="index.html">Trang chủ</a></li>
              <li><a href="menu.html">Thực đơn</a></li>
              <li><a href="cart.html">Giỏ hàng</a></li>
            </ul>
          </div>
          <div class="footer-column">
            <h3>Liên hệ</h3>
            <ul>
              <li><i class="fas fa-phone"></i> 0909 000 111</li>
              <li><i class="fas fa-envelope"></i> info@bestfood.com</li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">© 2025 BestFood</div>
      </div>
    </footer>

    <!-- Shared nav/login script (same logic as other pages) -->
    <script>
      (function () {
        const TOKEN_KEY = 'bestfood_token';
        const USER_KEY  = 'currentUser';

        const token = localStorage.getItem(TOKEN_KEY);
        let user = null;
        try { user = JSON.parse(localStorage.getItem(USER_KEY) || '{}'); } catch {}

        const nav = document.querySelector('.nav');
        if (nav) {
          const linkLogin    = nav.querySelector('a[href$="login.html"]');
          const linkRegister = nav.querySelector('a[href$="register.html"]');

          const el = (tag, attrs = {}, text = '') => {
            const x = document.createElement(tag);
            Object.entries(attrs).forEach(([k, v]) => x.setAttribute(k, v));
            if (text) x.textContent = text;
            return x;
          };

          if (token) {
            if (linkLogin)    linkLogin.style.display = 'none';
            if (linkRegister) linkRegister.style.display = 'none';

            if (!nav.querySelector('#navUserBadge')) {
              const dot = el('span', { class:'dot' }, '•');
              const badge = el('span', { id:'navUserBadge', class:'pill' },
                  (user && (user.name || user.phone)) ? (user.name || user.phone) : 'Đã đăng nhập');
              const logout = el('a', { href:'#', id:'navLogout' }, 'Đăng xuất');
              logout.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem(TOKEN_KEY);
                localStorage.removeItem(USER_KEY);
                location.href = 'index.html';
              });
              nav.appendChild(dot);
              nav.appendChild(badge);
              nav.appendChild(logout);
            }
          } else {
            if (linkLogin)    linkLogin.style.display = '';
            if (linkRegister) linkRegister.style.display = '';
            const badge  = nav.querySelector('#navUserBadge');
            const logout = nav.querySelector('#navLogout');
            if (badge)  badge.remove();
            if (logout) logout.remove();
          }
        }

        // prefill phone if user saved
        const phoneInput = document.querySelector('#phone');
        if (phoneInput && user && user.phone) {
          phoneInput.value = user.phone;
        }
      })();
    </script>

    <!-- Cart / checkout logic: reuse patterns from project cart page -->
    <script>
      const STORAGE_KEY = 'bestfood_cart';
      const currency = v => (Number(v)||0).toLocaleString('vi-VN') + ' đ';

      function loadCart(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } }

      function calcTotals(cart){
        const sub = cart.reduce((s,it)=> s + (Number(it.price)||0) * (Number(it.qty)||0), 0);
        const ship = sub >= 500000 ? 0 : (sub === 0 ? 0 : 20000);
        const discount = Number(localStorage.getItem('bestfood_coupon_discount') || 0);
        const grand = Math.max(0, sub + ship - discount);
        return { sub, ship, discount, grand };
      }

      function renderCartSummary(){
        const cart = loadCart();
        const listEl = document.getElementById('cartList');
        if(!cart.length){
          listEl.innerHTML = '<div class="muted">Giỏ hàng trống. <a href="menu.html">Quay lại thực đơn</a></div>';
        } else {
          listEl.innerHTML = cart.map(it => `
            <div class="cart-item">
              <img src="${it.image || 'https://picsum.photos/320/240'}" alt="${(it.name||'')}" />
              <div style="flex:1">
                <div style="font-weight:700">${it.name}</div>
                <div class="muted-small">Số lượng: ${it.qty} • ${it.unit||''}</div>
              </div>
              <div style="font-weight:800">${currency((Number(it.price)||0)*(Number(it.qty)||1))}</div>
            </div>
          `).join('');
        }

        const totals = calcTotals(cart);
        document.getElementById('subTotal').textContent = currency(totals.sub);
        document.getElementById('shipFee').textContent = currency(totals.ship);
        document.getElementById('discount').textContent = currency(totals.discount);
        document.getElementById('grandTotal').textContent = currency(totals.grand);
      }

      // coupon handling (same rules as cart)
      document.getElementById('applyCoupon').addEventListener('click', ()=>{
        const code = (document.getElementById('coupon').value || '').trim().toUpperCase();
        const cart = loadCart();
        const sub = calcTotals(cart).sub;
        let discount = 0;
        if(!code){ alert('Nhập mã giảm giá'); return; }
        if(code === 'PROMO20'){ discount = 20000; }
        else if(code === 'FIRST10' && sub >= 200000){ discount = Math.round(sub * 0.10); }
        else { alert('Mã không hợp lệ hoặc điều kiện chưa đạt'); return; }

        localStorage.setItem('bestfood_coupon_discount', String(discount));
        renderCartSummary();
        alert('Áp dụng mã thành công!');
      });

      document.getElementById('goCart').addEventListener('click', ()=> location.href = 'cart.html');

      // Place order (demo): save last order in localStorage and clear cart
      document.getElementById('placeOrder').addEventListener('click', ()=>{
        const cart = loadCart();
        if(!cart.length){ alert('Giỏ hàng trống'); return; }

        const form = document.getElementById('checkoutForm');
        // basic front validation
        if(!document.getElementById('firstName').value.trim() || !document.getElementById('lastName').value.trim() || !document.getElementById('phone').value.trim() || !document.getElementById('address').value.trim()){
          alert('Vui lòng điền đầy đủ thông tin giao hàng.');
          return;
        }

        const totals = calcTotals(cart);
        const order = {
          id: 'ORD-' + Date.now(),
          customer: {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            address: document.getElementById('address').value.trim(),
            notes: document.getElementById('notes').value.trim()
          },
          payment: document.querySelector('input[name="payment"]:checked').value,
          items: cart,
          totals,
          created_at: new Date().toISOString()
        };

        // demo: save to localStorage (replace with API call to backend)
        localStorage.setItem('bestfood_last_order', JSON.stringify(order));
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem('bestfood_coupon_discount');

        alert('Đặt hàng thành công! Mã đơn: ' + order.id);
        // redirect to order success or homepage
        location.href = 'index.html';
      });

      // init
      renderCartSummary();

      // update if cart changed in another tab
      window.addEventListener('storage', (e)=> {
        if(e.key === STORAGE_KEY || e.key === 'bestfood_coupon_discount') renderCartSummary();
      });
    </script>
  </body>
</html>
