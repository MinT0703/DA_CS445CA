<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Đăng ký - BestFood</title>
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="./style.css">
</head>
<body>

<header class="header">
  <div class="container">
    <div class="logo">Best<span>Food</span></div>
    <nav class="nav">
      <a href="index.html">Trang chủ</a>
      <a href="menu.html">Thực đơn</a>
      <a href="cart.html">Giỏ hàng</a>
      <a href="about_us.html">Giới thiệu</a>
      <a href="contact.html">Liên hệ</a>
      <a href="booking.html">Đặt món online</a>
      <a href="login.html">Đăng nhập</a>
      <a href="register.html">Đăng ký</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h1>Tạo tài khoản</h1>
    <p class="muted">Ảnh đại diện bắt buộc, phải là ảnh &lt; 1MB</p>

    <div id="alert" class="alert"></div>
    <div id="ok" class="ok"></div>

    <form id="regForm" novalidate>
      <div class="group">
        <label>Ảnh đại diện</label>
        <div class="file">
          <img id="preview" class="thumb" src="https://i.pravatar.cc/150?img=7" alt="avatar preview">
          <input id="avatar" name="avatar" type="file" accept="image/*" required>
        </div>
        <small class="err" data-err="avatar"></small>
      </div>

      <div class="grid">
        <div class="group">
          <label for="ten_nhan_vien">Họ và tên</label>
          <input id="ten_nhan_vien" name="ten_nhan_vien" type="text" placeholder="Nguyễn Văn A" required>
          <small class="err" data-err="ten_nhan_vien"></small>
        </div>
        <div class="group">
          <label for="so_dien_thoai">Số điện thoại</label>
          <input id="so_dien_thoai" name="so_dien_thoai" type="tel" placeholder="0912345678" required>
          <small class="err" data-err="so_dien_thoai"></small>
        </div>
      </div>

      <div class="grid">
        <div class="group">
          <label for="mat_khau">Mật khẩu</label>
          <input id="mat_khau" name="mat_khau" type="password" placeholder="Tối thiểu 6 ký tự" required>
          <small class="err" data-err="mat_khau"></small>
        </div>
        <div class="group">
          <label for="confirm">Xác nhận mật khẩu</label>
          <input id="confirm" type="password" placeholder="Nhập lại mật khẩu" required>
          <small class="err" data-err="confirm"></small>
        </div>
      </div>

      <div class="grid">
        <div class="group">
          <label for="ngay_sinh">Ngày sinh</label>
          <input id="ngay_sinh" name="ngay_sinh" type="date">
        </div>
        <div class="group">
          <label for="dia_chi">Địa chỉ</label>
          <input id="dia_chi" name="dia_chi" type="text" placeholder="Số nhà, đường, quận/huyện, tỉnh/thành">
        </div>
      </div>

      <button id="btnSubmit" class="btn" type="submit">Đăng ký</button>
    </form>
  </section>
</main>

<script>
  const API_BASE = 'http://localhost/CS403_BE-master/public/api';
  const REGISTER_URL = API_BASE + '/khach-hang/dang-ky';
  const MAX_SIZE = 1024*1024;
  const ALLOW_EXT = ['png','jpg','jpeg','webp'];

  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const show = (el,on=true)=>el.style.display=on?'block':'none';

  const fileInput=$('#avatar'), preview=$('#preview');
  fileInput.addEventListener('change',()=>{
    const f=fileInput.files?.[0];
    preview.src=f?URL.createObjectURL(f):'https://i.pravatar.cc/150?img=7';
  });

  function validate(){
    const errs={};
    const ten=$('#ten_nhan_vien').value.trim();
    const sdt=$('#so_dien_thoai').value.trim();
    const mk=$('#mat_khau').value;
    const cf=$('#confirm').value;
    const f=fileInput.files?.[0];

    if(!ten) errs.ten_nhan_vien='Vui lòng nhập họ và tên';
    if(!sdt) errs.so_dien_thoai='Vui lòng nhập số điện thoại';
    if(!mk||mk.length<6) errs.mat_khau='Mật khẩu tối thiểu 6 ký tự';
    if(cf!==mk) errs.confirm='Mật khẩu nhập lại không khớp';
    if(!f){errs.avatar='Vui lòng chọn ảnh';}
    else{
      const ext=(f.name.split('.').pop()||'').toLowerCase();
      if(f.size>MAX_SIZE) errs.avatar='Ảnh vượt quá 1MB';
      if(!ALLOW_EXT.includes(ext)) errs.avatar='Ảnh không hợp lệ';
    }
    return errs;
  }
  const setErr=(k,m='')=>{const e=document.querySelector(`[data-err="${k}"]`);if(e)e.textContent=m;};
  const clearErrs=()=>$$('.err').forEach(e=>e.textContent='');

  async function submitFormData(){
    const fd=new FormData();
    fd.append('ten_khach_hang',$('#ten_nhan_vien').value.trim());
    fd.append('so_dien_thoai',$('#so_dien_thoai').value.trim());
    fd.append('mat_khau',$('#mat_khau').value);
    if($('#ngay_sinh').value) fd.append('ngay_sinh',$('#ngay_sinh').value);
    if($('#dia_chi').value) fd.append('dia_chi',$('#dia_chi').value);
    fd.append('avatar',fileInput.files[0]);
    return fetch(REGISTER_URL,{method:'POST',body:fd,headers:{Accept:'application/json'}});
  }

  $('#regForm').addEventListener('submit',async e=>{
    e.preventDefault();clearErrs();show($('#alert'),false);show($('#ok'),false);
    const errs=validate();if(Object.keys(errs).length){Object.entries(errs).forEach(([k,v])=>setErr(k,v));return;}
    const btn=$('#btnSubmit');btn.disabled=true;btn.textContent='Đang gửi...';
    try{
      const res=await submitFormData();let data,raw;try{data=await res.json();}catch{raw=await res.text();}
      if(res.ok){$('#ok').textContent='Đăng ký thành công!';show($('#ok'),true);e.target.reset();preview.src='https://i.pravatar.cc/150?img=7'; location.href = 'login.html';}
      else{$('#alert').textContent=data?.message||raw||'Đăng ký thất bại';show($('#alert'),true);}
    }catch{ $('#alert').textContent='Không thể kết nối máy chủ.';show($('#alert'),true);}
    finally{btn.disabled=false;btn.textContent='Đăng ký';}
  });
</script>
<script>
    (function () {
      const TOKEN_KEY = 'bestfood_token';
      const USER_KEY  = 'currentUser';

      const token = localStorage.getItem(TOKEN_KEY);
      let user = null;
      try { user = JSON.parse(localStorage.getItem(USER_KEY) || '{}'); } catch {}

      const nav = document.querySelector('.nav');
      if (nav) {
        const linkLogin    = nav.querySelector('a[href$="login.html"]');
        const linkRegister = nav.querySelector('a[href$="register.html"]');

        const el = (tag, attrs = {}, text = '') => {
          const x = document.createElement(tag);
          Object.entries(attrs).forEach(([k, v]) => x.setAttribute(k, v));
          if (text) x.textContent = text;
          return x;
        };

        if (token) {
          if (linkLogin)    linkLogin.style.display = 'none';
          if (linkRegister) linkRegister.style.display = 'none';

          if (!nav.querySelector('#navUserBadge')) {
            const dot = el('span', { class:'dot' }, '•');
            const badge = el('span', { id:'navUserBadge', class:'pill' },
                (user && (user.name || user.phone)) ? (user.name || user.phone) : 'Đã đăng nhập');
            const logout = el('a', { href:'#', id:'navLogout' }, 'Đăng xuất');
            logout.addEventListener('click', (e) => {
              e.preventDefault();
              localStorage.removeItem(TOKEN_KEY);
              localStorage.removeItem(USER_KEY);
              location.href = 'index.html';
            });
            nav.appendChild(dot);
            nav.appendChild(badge);
            nav.appendChild(logout);
          }
        } else {
          if (linkLogin)    linkLogin.style.display = '';
          if (linkRegister) linkRegister.style.display = '';
          const badge  = nav.querySelector('#navUserBadge');
          const logout = nav.querySelector('#navLogout');
          if (badge)  badge.remove();
          if (logout) logout.remove();
        }
      }
      const phoneInput = document.querySelector('#phone');
      if (phoneInput && user && user.phone) {
        phoneInput.value = user.phone;
      }
    })();
</script>

</body>
</html>
