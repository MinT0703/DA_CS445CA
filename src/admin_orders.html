<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Quản lý Đơn hàng - BestFood (Admin)</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="./style.css">

  <style>
    /* Layout */
    .admin-container { max-width:1200px; margin:20px auto; padding:0 20px 40px; display:grid; grid-template-columns:260px 1fr; gap:18px; align-items:start; }
    .card-panel { background:#fff; border-radius:12px; padding:16px; box-shadow: var(--shadow); }
    .page-title { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

      .admin-sidebar {
      background:#2f3f49; color:#fff; border-radius:12px; padding:18px; height:calc(100vh - 120px); position:sticky; top:80px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .sidebar-title { margin: 0 0 12px 0; color:#f3fafc; font-size:18px; font-weight:800; }
    .admin-sidebar a { display:flex; gap:10px; align-items:center; color:#cbd8de; padding:8px 10px; border-radius:8px; text-decoration:none; margin-bottom:6px; }
    .admin-sidebar a.active, .admin-sidebar a:hover { background: rgba(255,255,255,0.04); color:#fff; }

    /* Table */
    .table-wrap { overflow:auto; margin-top:12px; }
    table.orders-table { width:100%; border-collapse:collapse; min-width:900px; }
    table.orders-table th, table.orders-table td { padding:12px 14px; border-bottom:1px solid #f3f4f6; text-align:left; vertical-align:middle; }
    table.orders-table th { background:#f6f8f9; color:#6b7280; font-weight:700; text-transform:uppercase; font-size:13px; }

    .status-pending { background:#f59e0b; color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .status-confirmed { background:#3b82f6; color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .status-preparing { background:#fb923c; color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .status-delivering { background:#06b6d4; color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .status-completed { background:#10b981; color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .status-cancelled { background:#9ca3af; color:#fff; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }

    .actions button { border:0; background:transparent; cursor:pointer; padding:6px; border-radius:8px; }
    .actions button:hover { background:#f3f4f6; }

    /* Order details modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:80; }
    .modal { width:820px; max-width:96%; background:#fff; border-radius:12px; padding:18px; box-shadow:var(--shadow); max-height:90vh; overflow:auto; }
    .order-items { width:100%; border-collapse:collapse; margin-top:8px; }
    .order-items th, .order-items td { padding:8px 10px; border-bottom:1px solid #f3f4f6; text-align:left; }
    .order-meta { display:flex; gap:18px; flex-wrap:wrap; margin-top:8px; }

    .muted { color:#6b7280; }
    .small { font-size:13px; }

    @media (max-width:900px) {
      .admin-container { grid-template-columns: 1fr; }
      table.orders-table { min-width:720px; }
      .modal { width:96%; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="logo">Best<span>Food</span></div>
      <nav class="nav" id="nav">
        <a href="admin_dashboard.html">Dashboard</a>
        <a href="admin_accounts.html">Tài Khoản</a>
        <a href="admin_menu.html">Món Ăn</a>
        <a href="admin_orders.html">Đơn Hàng</a>
        <a href="admin_promos.html">Voucher</a>
        <a href="login.html">Đăng xuất</a>
      </nav>
    </div>
  </header>

  <main class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar" aria-label="Admin sidebar">
      <h3 class="sidebar-title">Quản trị</h3>
      <a href="admin_dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
      <a href="admin_accounts.html"><i class="fas fa-users"></i> Quản lý Tài khoản</a>
      <a href="admin_menu.html"><i class="fas fa-utensils"></i> Quản lý Món ăn</a>
      <a href="admin_orders.html" class="active"><i class="fas fa-receipt"></i> Quản lý Đơn hàng</a>
      <a href="admin_promos.html"><i class="fas fa-tag"></i> Quản lý Khuyến mãi</a>
      <hr style="border-color: rgba(255,255,255,.04); margin:12px 0">
    </aside>

    <!-- Main -->
    <section class="main">
      <div class="card-panel page-title">
        <div>
          <h2 style="margin:0">Quản lý Đơn hàng</h2>
          <div class="muted small">Theo dõi & quản lý trạng thái các đơn hàng.</div>
        </div>

        <div class="controls">
          <button id="btnExport" class="btn btn-small" title="Xuất CSV"><i class="fa fa-file-csv"></i> Xuất CSV</button>
        </div>
      </div>

      <div class="card-panel">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <div style="flex:1; display:flex; gap:8px;">
            <input id="q" placeholder="Tìm theo ID, khách hàng, địa chỉ..." style="padding:10px 12px; border-radius:8px; border:1px solid #eee; width:100%" />
            <button id="btnSearch" class="btn btn-small"><i class="fa fa-search"></i></button>
          </div>

          <select id="filterStatus" style="padding:10px; border-radius:8px; border:1px solid #eee;">
            <option value="">Tất cả trạng thái</option>
            <option value="pending">Chờ xác nhận</option>
            <option value="confirmed">Đã xác nhận</option>
            <option value="preparing">Đang chuẩn bị</option>
            <option value="delivering">Đang giao</option>
            <option value="completed">Hoàn thành</option>
            <option value="cancelled">Đã huỷ</option>
          </select>

          <select id="filterPay" style="padding:10px; border-radius:8px; border:1px solid #eee;">
            <option value="">Tất cả phương thức</option>
            <option value="cod">COD</option>
            <option value="card">Thẻ / Online</option>
          </select>

          <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <div class="muted small">Hiển thị</div>
            <select id="pageSize" style="padding:8px; border-radius:8px; border:1px solid #eee;">
              <option value="5">5</option><option value="10" selected>10</option><option value="20">20</option>
            </select>
          </div>
        </div>

        <div class="table-wrap">
          <table class="orders-table" aria-live="polite">
            <thead>
              <tr>
                <th>ID</th>
                <th>Khách hàng</th>
                <th>Tổng tiền</th>
                <th>Phương thức</th>
                <th>Trạng thái</th>
                <th>Ngày đặt</th>
                <th style="width:160px">Hành động</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- injected -->
            </tbody>
          </table>
        </div>

        <div class="pagination" id="pagination" style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end; align-items:center;"></div>
      </div>
    </section>
  </main>

  <div id="modalRoot" style="display:none"></div>

<script>
/* ========== CONFIG ========== */
const USE_API = false;
const API_LIST = '/api/admin/orders';
const API_UPDATE = id => `/api/admin/orders/${id}`;

/* ========== DEMO DATA ========== */
const demoOrders = [
  {
    id: 'ORD-20251130-001',
    customer: { name: 'Nguyễn Văn A', phone: '0912345678', address: '123 Đường A, Quận 1, TP HCM' },
    items: [
      { name: 'Phở Bò', qty: 2, price: 65000 },
      { name: 'Bánh mì kẹp', qty: 1, price: 30000 }
    ],
    subtotal: 160000,
    shipping: 15000,
    discount: 0,
    total: 175000,
    payment: 'cod',
    status: 'pending',
    note: 'Giao trước 12h nếu được',
    created_at: '2025-11-30 12:12'
  },
  {
    id: 'ORD-20251130-002',
    customer: { name: 'Lê Thị B', phone: '0987654321', address: '45 Đường B, Quận 3, TP HCM' },
    items: [
      { name: 'Gà rán', qty: 1, price: 85000 },
      { name: 'Bún chả', qty: 2, price: 59000 }
    ],
    subtotal: 203000,
    shipping: 15000,
    discount: 30000,
    total: 188000,
    payment: 'card',
    status: 'delivering',
    note: '',
    created_at: '2025-11-29 18:05'
  },
  {
    id: 'ORD-20251129-003',
    customer: { name: 'Trần Văn C', phone: '0901122334', address: 'Số 7, Phố C, Hà Nội' },
    items: [
      { name: 'Cơm tấm sườn', qty: 1, price: 70000 }
    ],
    subtotal: 70000,
    shipping: 10000,
    discount: 0,
    total: 80000,
    payment: 'cod',
    status: 'completed',
    note: 'Không hành',
    created_at: '2025-11-29 11:20'
  }
];

/* ========== STATE ========== */
let rows = [];
let filtered = [];
let page = 1;
let pageSize = Number(document.getElementById('pageSize')?.value || 10);

/* ========== HELPERS ========== */
const $ = s => document.querySelector(s);
function escapeHtml(s=''){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const fmtMoney = v => (Number(v)||0).toLocaleString('vi-VN') + ' đ';

function statusBadge(status){
  switch(status){
    case 'pending': return '<span class="status-pending">Chờ xác nhận</span>';
    case 'confirmed': return '<span class="status-confirmed">Đã xác nhận</span>';
    case 'preparing': return '<span class="status-preparing">Đang chuẩn bị</span>';
    case 'delivering': return '<span class="status-delivering">Đang giao</span>';
    case 'completed': return '<span class="status-completed">Hoàn thành</span>';
    case 'cancelled': return '<span class="status-cancelled">Đã huỷ</span>';
    default: return `<span class="status-pending">${escapeHtml(status)}</span>`;
  }
}

/* ========== DATA LOAD ========== */
async function fetchOrders(){
  if(USE_API){
    try{
      const res = await fetch(API_LIST, { headers:{Accept:'application/json'} });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      rows = Array.isArray(json.data) ? json.data : (Array.isArray(json.orders) ? json.orders : json);
    }catch(err){
      console.warn('API orders failed', err);
      rows = demoOrders.slice();
    }
  } else {
    rows = demoOrders.slice();
  }
  applyFilters();
}

/* ========== RENDER ========= */
function renderTable(){
  const tbody = $('#tableBody');
  tbody.innerHTML = '';
  const start = (page-1)*pageSize;
  const pageRows = filtered.slice(start, start + pageSize);
  if(!pageRows.length){
    tbody.innerHTML = `<tr><td colspan="7" class="muted">Không có dữ liệu</td></tr>`;
    renderPagination();
    return;
  }
  for(const r of pageRows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.id)}</td>
      <td>
        <div style="font-weight:700">${escapeHtml(r.customer?.name||'')}</div>
        <div class="muted small">${escapeHtml(r.customer?.phone||'')}</div>
      </td>
      <td style="font-weight:800">${fmtMoney(r.total)}</td>
      <td class="muted small">${r.payment === 'cod' ? 'COD' : 'Thẻ/Online'}</td>
      <td>${statusBadge(r.status)}</td>
      <td class="muted small">${escapeHtml(r.created_at||'')}</td>
      <td class="actions">
        <button title="Xem" data-id="${escapeHtml(r.id)}" class="viewBtn"><i class="fa fa-eye"></i></button>
        <button title="Cập nhật trạng thái" data-id="${escapeHtml(r.id)}" class="editBtn"><i class="fa fa-pen"></i></button>
        <button title="In hoá đơn" data-id="${escapeHtml(r.id)}" class="printBtn"><i class="fa fa-print"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  attachRowHandlers();
  renderPagination();
}

function renderPagination(){
  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  const container = $('#pagination');
  container.innerHTML = '';

  const info = document.createElement('div');
  info.style.marginRight = 'auto';
  info.className = 'muted small';
  info.textContent = `Hiển thị ${Math.min((page-1)*pageSize+1, total)} - ${Math.min(page*pageSize, total)} / ${total}`;
  container.appendChild(info);

  const prev = document.createElement('button');
  prev.className = 'page-btn'; prev.textContent = '‹';
  prev.disabled = page <= 1;
  prev.addEventListener('click', ()=> { if(page>1) { page--; renderTable(); }});
  container.appendChild(prev);

  const startPage = Math.max(1, page - 2);
  const endPage = Math.min(totalPages, startPage + 4);
  for(let p = startPage; p<=endPage; p++){
    const b = document.createElement('button');
    b.className = 'page-btn' + (p===page ? ' active' : '');
    b.textContent = String(p);
    b.addEventListener('click', ()=> { page = p; renderTable(); });
    container.appendChild(b);
  }

  const next = document.createElement('button');
  next.className = 'page-btn'; next.textContent = '›';
  next.disabled = page >= totalPages;
  next.addEventListener('click', ()=> { if(page<totalPages) { page++; renderTable(); }});
  container.appendChild(next);
}

/* ========== FILTERS ========= */
function applyFilters(){
  const q = ($('#q').value || '').trim().toLowerCase();
  const status = $('#filterStatus').value;
  const pay = $('#filterPay').value;
  filtered = rows.filter(r => {
    const matchQ = !q || (
      String(r.id||'').toLowerCase().includes(q) ||
      String(r.customer?.name||'').toLowerCase().includes(q) ||
      String(r.customer?.address||'').toLowerCase().includes(q)
    );
    const matchStatus = !status || (r.status === status);
    const matchPay = !pay || (r.payment === pay);
    return matchQ && matchStatus && matchPay;
  });
  page = 1;
  renderTable();
}

/* ========== HANDLERS ========= */
function attachRowHandlers(){
  document.querySelectorAll('.viewBtn').forEach(b => b.onclick = ()=> openViewModal(b.dataset.id));
  document.querySelectorAll('.editBtn').forEach(b => b.onclick = ()=> openEditStatusModal(b.dataset.id));
  document.querySelectorAll('.printBtn').forEach(b => b.onclick = ()=> printInvoice(b.dataset.id));
}

$('#btnSearch').addEventListener('click', ()=> applyFilters());
$('#q').addEventListener('keyup', e => { if(e.key === 'Enter') applyFilters(); });
$('#filterStatus').addEventListener('change', ()=> applyFilters());
$('#filterPay').addEventListener('change', ()=> applyFilters());
$('#pageSize').addEventListener('change', e => { pageSize = Number(e.target.value||10); page = 1; renderTable(); });

$('#btnExport').addEventListener('click', ()=> {
  const cols = ['id','customer_name','phone','address','total','payment','status','created_at'];
  const lines = [cols.join(',')];
  for(const r of filtered){
    const row = [
      `"${escapeQuote(r.id)}"`,
      `"${escapeQuote(r.customer?.name||'')}"`,
      `"${escapeQuote(r.customer?.phone||'')}"`,
      `"${escapeQuote(r.customer?.address||'')}"`,
      `"${Number(r.total||0)}"`,
      `"${r.payment||''}"`,
      `"${r.status||''}"`,
      `"${r.created_at||''}"`
    ].join(',');
    lines.push(row);
  }
  const csv = lines.join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `orders_export_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
});

function escapeQuote(s=''){ return String(s||'').replace(/"/g,'""'); }

/* ========== VIEW ORDER ========== */
function showModal(html){
  const root = $('#modalRoot');
  root.innerHTML = `<div class="modal-backdrop">${html}</div>`;
  root.style.display = 'block';
  root.querySelector('.modal-backdrop').addEventListener('click', (e)=> {
    if(e.target.classList.contains('modal-backdrop')) closeModal();
  });
}
function closeModal(){ $('#modalRoot').style.display = 'none'; $('#modalRoot').innerHTML = ''; }

function openViewModal(id){
  const order = rows.find(o => String(o.id) === String(id));
  if(!order) return alert('Không tìm thấy đơn hàng');
  const itemsHtml = order.items.map(it => `<tr><td>${escapeHtml(it.name)}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">${fmtMoney(it.price)}</td><td style="text-align:right">${fmtMoney(it.qty * it.price)}</td></tr>`).join('');
  const html = `
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Chi tiết đơn: ${escapeHtml(order.id)}</h3>

      <div class="order-meta">
        <div><strong>Khách hàng</strong><div class="muted small">${escapeHtml(order.customer?.name||'')} — ${escapeHtml(order.customer?.phone||'')}</div></div>
        <div style="min-width:240px"><strong>Địa chỉ</strong><div class="muted small">${escapeHtml(order.customer?.address||'')}</div></div>
        <div><strong>Phương thức</strong><div class="muted small">${order.payment === 'cod' ? 'COD' : 'Thẻ/Online'}</div></div>
        <div><strong>Ngày</strong><div class="muted small">${escapeHtml(order.created_at||'')}</div></div>
      </div>

      <table class="order-items" role="table" aria-label="Các món">
        <thead><tr><th>Món</th><th style="width:80px;text-align:center">Số lượng</th><th style="width:120px;text-align:right">Đơn giá</th><th style="width:120px;text-align:right">Thành tiền</th></tr></thead>
        <tbody>${itemsHtml}</tbody>
        <tfoot>
          <tr><td colspan="3" style="text-align:right;padding-top:10px"><strong>Tạm tính</strong></td><td style="text-align:right;padding-top:10px">${fmtMoney(order.subtotal)}</td></tr>
          <tr><td colspan="3" style="text-align:right"><strong>Phí vận chuyển</strong></td><td style="text-align:right">${fmtMoney(order.shipping)}</td></tr>
          <tr><td colspan="3" style="text-align:right"><strong>Giảm</strong></td><td style="text-align:right">-${fmtMoney(order.discount)}</td></tr>
          <tr><td colspan="3" style="text-align:right;font-size:18px"><strong>Tổng</strong></td><td style="text-align:right;font-size:18px"><strong>${fmtMoney(order.total)}</strong></td></tr>
        </tfoot>
      </table>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:flex-end">
        <button class="btn" id="closeView">Đóng</button>
        <button class="btn" id="printFromView" style="background:#6b7280;color:#fff"><i class="fa fa-print"></i> In hoá đơn</button>
      </div>
    </div>
  `;
  showModal(html);
  $('#closeView').addEventListener('click', closeModal);
  $('#printFromView').addEventListener('click', ()=> {
    printInvoice(id);
  });
}

/* ========== EDIT STATUS ========== */
function openEditStatusModal(id){
  const order = rows.find(o => String(o.id) === String(id));
  if(!order) return alert('Không tìm thấy đơn hàng');
  const html = `
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Cập nhật trạng thái: ${escapeHtml(order.id)}</h3>
      <div style="margin-top:12px">
        <label style="display:block;margin-bottom:6px">Trạng thái hiện tại: <strong>${escapeHtml(order.status)}</strong></label>
        <select id="m_status" style="padding:10px;border-radius:8px;border:1px solid #eee">
          <option value="pending"${order.status==='pending'?' selected':''}>Chờ xác nhận</option>
          <option value="confirmed"${order.status==='confirmed'?' selected':''}>Đã xác nhận</option>
          <option value="preparing"${order.status==='preparing'?' selected':''}>Đang chuẩn bị</option>
          <option value="delivering"${order.status==='delivering'?' selected':''}>Đang giao</option>
          <option value="completed"${order.status==='completed'?' selected':''}>Hoàn thành</option>
          <option value="cancelled"${order.status==='cancelled'?' selected':''}>Đã huỷ</option>
        </select>

        <div style="margin-top:10px">
          <label style="display:block;margin-bottom:6px">Ghi chú / lý do (tuỳ chọn)</label>
          <textarea id="m_note" rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee">${escapeHtml(order.note||'')}</textarea>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn" id="m_cancel">Huỷ</button>
          <button class="btn" id="m_save" style="background:var(--primary-color);color:#fff">Lưu</button>
        </div>
      </div>
    </div>
  `;
  showModal(html);
  $('#m_cancel').addEventListener('click', closeModal);
  $('#m_save').addEventListener('click', async ()=> {
    const newStatus = $('#m_status').value;
    const note = $('#m_note').value.trim();
    await updateOrderStatus(id, newStatus, note);
    closeModal();
  });
}

async function updateOrderStatus(id, newStatus, note){
  if(USE_API){
    try{
      const res = await fetch(API_UPDATE(id), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status: newStatus, note })});
      if(!res.ok) throw new Error('HTTP ' + res.status);
      await fetchOrders();
      return;
    }catch(err){
      alert('Cập nhật thất bại'); console.error(err);
      return;
    }
  } else {
    const idx = rows.findIndex(r => String(r.id) === String(id));
    if(idx === -1) return;
    rows[idx].status = newStatus;
    rows[idx].note = note;
    applyFilters();
  }
}

/* ========== PRINT / INVOICE ========== */
function printInvoice(id){
  const order = rows.find(o => String(o.id) === String(id));
  if(!order) return alert('Không tìm thấy đơn hàng');
  // generate simple invoice HTML
  const itemsHtml = order.items.map(it => `<tr><td>${escapeHtml(it.name)}</td><td style="text-align:center">${it.qty}</td><td style="text-align:right">${fmtMoney(it.price)}</td><td style="text-align:right">${fmtMoney(it.qty * it.price)}</td></tr>`).join('');
  const invoice = `
    <html>
      <head>
        <title>Hoá đơn ${escapeQuote(order.id)}</title>
        <style>
          body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#111}
          h2{margin-bottom:6px}
          table{width:100%;border-collapse:collapse;margin-top:12px}
          th,td{padding:8px 6px;border-bottom:1px solid #ddd}
          .right{text-align:right}
        </style>
      </head>
      <body>
        <h2>BestFood - Hoá đơn</h2>
        <div>Đơn hàng: <strong>${escapeQuote(order.id)}</strong></div>
        <div>Khách: ${escapeQuote(order.customer?.name||'')} — ${escapeQuote(order.customer?.phone||'')}</div>
        <div>Địa chỉ: ${escapeQuote(order.customer?.address||'')}</div>
        <div>Ngày: ${escapeQuote(order.created_at||'')}</div>

        <table>
          <thead><tr><th>Món</th><th style="width:80px">SL</th><th style="width:120px" class="right">Đơn giá</th><th style="width:120px" class="right">Thành tiền</th></tr></thead>
          <tbody>${itemsHtml}</tbody>
          <tfoot>
            <tr><td colspan="3" class="right">Tạm tính</td><td class="right">${fmtMoney(order.subtotal)}</td></tr>
            <tr><td colspan="3" class="right">Phí vận chuyển</td><td class="right">${fmtMoney(order.shipping)}</td></tr>
            <tr><td colspan="3" class="right">Giảm</td><td class="right">-${fmtMoney(order.discount)}</td></tr>
            <tr><td colspan="3" class="right"><strong>Tổng</strong></td><td class="right"><strong>${fmtMoney(order.total)}</strong></td></tr>
          </tfoot>
        </table>

        <div style="margin-top:18px">Cảm ơn quý khách!</div>
      </body>
    </html>
  `;
  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(invoice);
  w.document.close();
  w.focus();
  w.print();
}

/* ========== INIT ========== */
(async function init(){
  // sidebar active
  (function() {
    const path = location.pathname.split('/').pop().toLowerCase() || 'admin_orders.html';
    const map = {
      'admin_dashboard.html': 'dashboard',
      'admin_accounts.html': 'accounts',
      'admin_menu.html': 'menu',
      'admin_orders.html': 'orders',
      'admin_promos.html': 'promos'
    };
    const key = map[path] || Object.keys(map).find(k => path.includes(k)) || 'orders';
    document.querySelectorAll('.admin-sidebar-common .nav-link').forEach(a=>{
      a.classList.toggle('active', a.dataset.key === key);
    });
  })();

  await fetchOrders();

  // default binds (already set above for some)
  document.getElementById('btnSearch').addEventListener('click', ()=> applyFilters());
  document.getElementById('q').addEventListener('keyup', e => { if(e.key === 'Enter') applyFilters(); });
  document.getElementById('filterStatus').addEventListener('change', ()=> applyFilters());
  document.getElementById('filterPay').addEventListener('change', ()=> applyFilters());
  document.getElementById('pageSize').addEventListener('change', e => { pageSize = Number(e.target.value||10); page = 1; renderTable(); });
})();
</script>

</body>
</html>
