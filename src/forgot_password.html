<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quên mật khẩu - BestFood</title>
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .card { max-width: 420px; margin: 20px auto; }
    .helper { text-align:center; margin-top:12px; color:var(--muted); font-size:14px; }
    .small-link { display:block; text-align:center; margin-top:12px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="logo">Best<span>Food</span></div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Quên mật khẩu</h2>
      <p class="muted">Nhập email hoặc số điện thoại của bạn để nhận liên kết đặt lại mật khẩu.</p>

      <div id="alert" class="alert" role="alert"></div>
      <div id="ok" class="ok" role="status"></div>

      <form id="forgotForm" novalidate>
        <div class="group">
          <label for="identity">Email hoặc SĐT</label>
          <input id="identity" name="identity" type="text" placeholder="you@example.com hoặc 0912345678" required />
          <small class="err" data-err="identity"></small>
        </div>

        <button id="btnSend" class="btn" type="submit">Gửi liên kết đặt lại</button>

        <p class="helper">Nếu bạn không nhận được email, kiểm tra thư mục Spam hoặc thử lại.</p>

        <p class="small-link"><a href="login.html" style="color:var(--primary-color); text-decoration:none;">← Quay lại đăng nhập</a></p>
      </form>
    </section>
  </main>

  <footer>© 2025 BestFood</footer>

  <script>
    (function(){
      const API_BASE = 'http://localhost/CS403_BE-master/public/api';
      const RESET_ENDPOINT = API_BASE + '/khach-hang/quen-mat-khau';

      const $ = s => document.querySelector(s);
      const show = (el,on=true) => el.style.display = on ? 'block' : 'none';
      const setErr = (k,m='') => { const e=document.querySelector(`[data-err="${k}"]`); if(e) e.textContent = m; };

      const form = $('#forgotForm');
      const identity = $('#identity');
      const alertBox = $('#alert');
      const okBox = $('#ok');
      const btn = $('#btnSend');

      function clearMessages(){
        alertBox.style.display = 'none';
        okBox.style.display = 'none';
        alertBox.textContent = '';
        okBox.textContent = '';
        setErr('identity','');
      }

      function validate(){
        const v = (identity.value||'').trim();
        if(!v) return 'Vui lòng nhập email hoặc số điện thoại';
        if(v.includes('@')) {
          if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) return 'Định dạng email không hợp lệ';
        } else {
          const digits = v.replace(/\D/g,'');
          if(digits.length < 9 || digits.length > 12) return 'Số điện thoại không hợp lệ';
        }
        return '';
      }

      async function sendResetRequest(payload){
       
        try{
          const res = await fetch(RESET_ENDPOINT, {
            method: 'POST',
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          return res;
        }catch(err){
          console.warn('Không gửi được tới API:', err);
          throw err;
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessages();

        const vErr = validate();
        if(vErr){
          setErr('identity', vErr);
          return;
        }

        btn.disabled = true;
        btn.textContent = 'Đang gửi...';

        const value = identity.value.trim();
        const payload = value.includes('@') ? { email: value } : { so_dien_thoai: value };

        try{
          const res = await sendResetRequest(payload);
          if(res && res.ok){
            let data = null;
            try { data = await res.json(); } catch {}
            okBox.textContent = (data && (data.message || data.msg)) ? (data.message || data.msg) : 'Liên kết đặt lại mật khẩu đã được gửi — kiểm tra email hoặc SMS.';
            show(okBox, true);
          } else {
            let txt = `Không thể gửi liên kết (HTTP ${res ? res.status : '??'})`;
            try { const j = await res.json(); if(j && j.message) txt = j.message; } catch {}
            alertBox.textContent = txt;
            show(alertBox, true);
          }
        }catch(err){
          okBox.textContent = 'Yêu cầu đã được xử lý ở chế độ demo (không có backend). Nếu bạn đang phát triển, đảm bảo API endpoint hoạt động.';
          show(okBox, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Gửi liên kết đặt lại';
        }
      });

      (function navSync(){
        const TOKEN_KEY = 'bestfood_token';
        const USER_KEY  = 'currentUser';
        const token = localStorage.getItem(TOKEN_KEY);
        let user = null;
        try{ user = JSON.parse(localStorage.getItem(USER_KEY) || '{}'); }catch{}
        const nav = document.querySelector('.nav');
        if(!nav) return;
        const linkLogin    = nav.querySelector('a[href$="login.html"]');
        const linkRegister = nav.querySelector('a[href$="register.html"]');
        const el = (tag, attrs = {}, text = '') => { const x = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>x.setAttribute(k,v)); if(text) x.textContent = text; return x; };
        if(token){
          if(linkLogin) linkLogin.style.display='none';
          if(linkRegister) linkRegister.style.display='none';
          if(!nav.querySelector('#navUserBadge')){
            const dot = el('span',{class:'dot'},'•');
            const badge = el('span',{id:'navUserBadge',class:'pill'}, (user && (user.name||user.phone)) ? (user.name||user.phone) : 'Đã đăng nhập');
            const logout = el('a',{href:'#', id:'navLogout'}, 'Đăng xuất');
            logout.addEventListener('click',(ev)=>{ ev.preventDefault(); localStorage.removeItem(TOKEN_KEY); localStorage.removeItem(USER_KEY); location.href='index.html'; });
            nav.appendChild(dot); nav.appendChild(badge); nav.appendChild(logout);
          }
        } else {
          if(linkLogin) linkLogin.style.display='';
          if(linkRegister) linkRegister.style.display='';
          const badge = nav.querySelector('#navUserBadge'); if(badge) badge.remove();
          const logout = nav.querySelector('#navLogout'); if(logout) logout.remove();
        }
      })();

    })();
  </script>
</body>
</html>
