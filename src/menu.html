<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thực đơn - BestFood</title>
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="./style.css">
  
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="logo">Best<span>Food</span></div>
      <nav class="nav" id="nav">
        <a href="index.html">Trang chủ</a>
        <a href="menu.html">Thực đơn</a>
        <a href="cart.html">Giỏ hàng</a>
        <a href="about_us.html">Giới thiệu</a>
        <a href="contact.html">Liên hệ</a>
        <a href="booking.html">Đặt món online</a>
        <a href="login.html" id="goLogin">Đăng nhập</a>
        <a href="register.html" id="goRegister">Đăng ký</a>
      </nav>
      <div class="mobile-menu" id="mobileMenu" aria-label="menu"><i class="fas fa-bars"></i></div>
    </div>
  </header>

  <!-- HERO -->
  <section class="menu-hero">
    <h1>Thực đơn hôm nay</h1>
    <p>Chọn món bạn yêu thích từ các danh mục: Khai vị, Món chính, Tráng miệng, Đồ uống.</p>
  </section>

  <!-- FILTERS -->
  <div class="filter-bar">
    <div class="search-wrap">
      <input type="search" id="q" placeholder="Tìm món theo tên, mô tả..."/>
    </div>
    <div class="category-pills" id="catPills">
      <button class="pill active" data-cat="all">Tất cả</button>
      <button class="pill" data-cat="Khai vị">Khai vị</button>
      <button class="pill" data-cat="Món chính">Món chính</button>
      <button class="pill" data-cat="Tráng miệng">Tráng miệng</button>
      <button class="pill" data-cat="Đồ uống">Đồ uống</button>
    </div>
    <div class="sort-wrap">
      <select id="sort">
        <option value="popular">Phổ biến</option>
        <option value="price_asc">Giá ↑</option>
        <option value="price_desc">Giá ↓</option>
        <option value="name_asc">Tên A→Z</option>
      </select>
    </div>
  </div>

  <!-- GRID -->
  <section class="menu-grid" id="grid"></section>
  <div class="load-more-wrap"><button class="btn-more" id="btnMore">Xem thêm</button></div>

  <footer><p>© 2025 BestFood. All rights reserved.</p></footer>
  <script>
    const API_BASE = 'http://localhost/CS403_BE-master/public/api';
    const PAGE_SIZE = 6;
    const CATEGORY_MAP = {
      1: "Khai vị",
      2: "Món chính",
      3: "Tráng miệng",
      4: "Đồ uống",
      5: "Đồ chay"
    };

    const grid    = document.getElementById('grid');
    const qInput  = document.getElementById('q');
    const sortSel = document.getElementById('sort');
    const btnMore = document.getElementById('btnMore');
    const catWrap = document.getElementById('catPills');

    const currency = v => (Number(v)||0).toLocaleString('vi-VN') + ' đ';

    function normalize(item){
      return {
        id: item.id,
        name: item.ten_mon_an,
        desc: item.mo_ta_ngan,
        price: Number(item.gia)||0,
        image: item.hinh_anh || 'https://picsum.photos/640/360',
        unit: item.don_vi_tinh || '',
        category: CATEGORY_MAP[item.id_the_loai] || 'Khác',
        _raw: item
      };
    }

    function cardHTML(m){
      return `
        <article class="card">
          <img src="${m.image}" alt="${m.name}" loading="lazy" onerror="this.src='https://picsum.photos/640/360'"/>
          <div class="card-body">
            <h3 class="card-title">${m.name}</h3>
            <div class="meta">
              <span class="price">${currency(m.price)}</span>
              <span class="badge">${m.unit}</span>
            </div>
            <p class="desc">${m.desc || ''}</p>
            <div class="add-row">
              <input class="qty" type="number" min="1" value="1" aria-label="Số lượng">
              <button class="btn-add" data-id="${m.id}">Thêm món</button>
            </div>
          </div>
        </article>`;
    }

    let rawData = [];
    let viewData = [];
    let page = 1;

    function renderGrid(reset=false){
      const start = (page-1)*PAGE_SIZE;
      const slice = viewData.slice(start, start+PAGE_SIZE);
      if(reset) grid.innerHTML = '';
      grid.insertAdjacentHTML('beforeend', slice.map(cardHTML).join(''));
      btnMore.style.display = (start + PAGE_SIZE < viewData.length) ? 'inline-block' : 'none';
    }

    function currentCategory(){
      const active = catWrap.querySelector('.pill.active');
      return active ? active.dataset.cat : 'all';
    }

    function applyFilters(){
      const q = (qInput.value||'').toLowerCase().trim();
      const cat = currentCategory();

      let data = rawData.slice();
      if(cat !== 'all') data = data.filter(m => (m.category||'').toLowerCase() === cat.toLowerCase());
      if(q) data = data.filter(m => m.name.toLowerCase().includes(q) || (m.desc||'').toLowerCase().includes(q));

      const s = sortSel.value;
      if(s==='price_asc')  data.sort((a,b)=>a.price-b.price);
      if(s==='price_desc') data.sort((a,b)=>b.price-a.price);
      if(s==='name_asc')   data.sort((a,b)=>a.name.localeCompare(b.name,'vi'));
      if(s==='popular')    data.sort((a,b)=> (b._raw?.popular ?? 0) - (a._raw?.popular ?? 0) || a.name.localeCompare(b.name,'vi'));

      viewData = data;
      page = 1;
      renderGrid(true);
    }

    async function fetchMenu(){
      try{
        const res = await fetch(`${API_BASE}/thuc-don/data`, { headers: { 'Accept': 'application/json' }});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        const list = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
        rawData = list.map(normalize);
        applyFilters();
      }catch(err){
        console.error(err);
        grid.innerHTML = `
          <div class="card" style="padding:16px">
            Không tải được dữ liệu. Kiểm tra API tại: <code>${API_BASE}/thuc-don/data</code>
          </div>`;
      }
    }

    qInput.addEventListener('input', applyFilters);
    sortSel.addEventListener('change', applyFilters);
    btnMore.addEventListener('click', ()=>{ page++; renderGrid(); });

    catWrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('.pill'); if(!btn) return;
      catWrap.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    });

grid.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-add'); if(!btn) return;
  const card = btn.closest('.card');
  const id = btn.dataset.id;
  const qty = Number(card.querySelector('.qty').value || 1);
  const title = card.querySelector('.card-title')?.textContent?.trim() || ('Món #' + id);
  const priceText = card.querySelector('.price')?.textContent || '0 đ';
  const price = Number(String(priceText).replace(/[^\d]/g,'')) || 0;
  const img = card.querySelector('img')?.src || '';

  const key = 'bestfood_cart';
  let cart = [];
  try { cart = JSON.parse(localStorage.getItem(key) || '[]'); } catch {}
  const idx = cart.findIndex(i => String(i.id) === String(id));
  if(idx >= 0) cart[idx].qty = Number(cart[idx].qty || 0) + qty;
  else cart.push({ id, name: title, price, qty, image: img, unit: card.querySelector('.badge')?.textContent || '' });

  localStorage.setItem(key, JSON.stringify(cart));
  // Tùy chọn: show toast / badge / animation
  alert(`Đã thêm ${qty} x "${title}" vào giỏ`);
  // emit storage event for same-tab update (some browsers don't fire storage in same tab)
  window.dispatchEvent(new StorageEvent('storage', { key, newValue: JSON.stringify(cart) }));
});

    fetchMenu();
  </script>
  <script>
    (function () {
      const TOKEN_KEY = 'bestfood_token';
      const USER_KEY  = 'currentUser';

      const token = localStorage.getItem(TOKEN_KEY);
      let user = null;
      try { user = JSON.parse(localStorage.getItem(USER_KEY) || '{}'); } catch {}

      const nav = document.querySelector('.nav');
      if (nav) {
        const linkLogin    = nav.querySelector('a[href$="login.html"]');
        const linkRegister = nav.querySelector('a[href$="register.html"]');

        const el = (tag, attrs = {}, text = '') => {
          const x = document.createElement(tag);
          Object.entries(attrs).forEach(([k, v]) => x.setAttribute(k, v));
          if (text) x.textContent = text;
          return x;
        };

        if (token) {
          if (linkLogin)    linkLogin.style.display = 'none';
          if (linkRegister) linkRegister.style.display = 'none';

          if (!nav.querySelector('#navUserBadge')) {
            const dot = el('span', { class:'dot' }, '•');
            const badge = el('span', { id:'navUserBadge', class:'pill' },
                (user && (user.name || user.phone)) ? (user.name || user.phone) : 'Đã đăng nhập');
            const logout = el('a', { href:'#', id:'navLogout' }, 'Đăng xuất');
            logout.addEventListener('click', (e) => {
              e.preventDefault();
              localStorage.removeItem(TOKEN_KEY);
              localStorage.removeItem(USER_KEY);
              location.href = 'index.html';
            });
            nav.appendChild(dot);
            nav.appendChild(badge);
            nav.appendChild(logout);
          }
        } else {
          if (linkLogin)    linkLogin.style.display = '';
          if (linkRegister) linkRegister.style.display = '';
          const badge  = nav.querySelector('#navUserBadge');
          const logout = nav.querySelector('#navLogout');
          if (badge)  badge.remove();
          if (logout) logout.remove();
        }
      }
      const phoneInput = document.querySelector('#phone');
      if (phoneInput && user && user.phone) {
        phoneInput.value = user.phone;
      }
    })();
    </script>

</body>
</html>
