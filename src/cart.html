<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giỏ hàng - BestFood</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./style.css" />

  <style>
    .cart-hero {
      background: linear-gradient( rgba(0,0,0,.25), rgba(0,0,0,.25) ),
                  url("https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=1400&q=80") center/cover no-repeat;
      color: #fff;
      padding: 56px 0;
      text-align: center;
    }
    .cart-wrap { max-width:1200px; margin: 22px auto; padding: 0 20px; }
    .cart-grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
    }
    @media (max-width: 900px) { .cart-grid { grid-template-columns: 1fr; } }

    .cart-list { display:flex; flex-direction:column; gap:12px; }
    .cart-item {
      display:flex; gap:12px; align-items:center;
      padding:12px; border-radius:12px; background:#fff;
      border:1px solid #f3f4f6;
    }
    .cart-item img { width:92px; height:72px; object-fit:cover; border-radius:8px; }
    .ci-body { flex:1; display:flex; flex-direction:column; gap:6px; }
    .ci-title { font-weight:700; color:var(--dark-color); }
    .ci-meta { display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px; }
    .ci-actions { display:flex; gap:8px; align-items:center; }

    .qty-control { display:flex; align-items:center; gap:8px; }
    .qty-control button {
      width:30px; height:30px; border-radius:8px; border:1px solid #eee; background:#fff; cursor:pointer;
    }
    .qty-control input { width:56px; text-align:center; padding:6px 8px; border-radius:8px; border:1px solid #eee; }

    .summary { background:#fff; padding:18px; border-radius:12px; border:1px solid #f3f4f6; }
    .summary h3 { margin:0 0 12px; }
    .row { display:flex; justify-content:space-between; align-items:center; margin:8px 0; }
    .total { font-weight:900; font-size:18px; color:var(--primary); }
    .muted-small { font-size:13px; color:var(--muted); }

    .empty-cart { text-align:center; padding:28px; background:#fff; border-radius:12px; border:1px dashed #eee; color:var(--muted); }
    .cart-actions { display:flex; gap:10px; margin-top:12px; }
    .btn-checkout { background: linear-gradient(90deg,var(--primary) 0%, #c0392b 100%); }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="logo">Best<span>Food</span></div>
      <nav class="nav">
        <a href="index.html">Trang chủ</a>
        <a href="menu.html">Thực đơn</a>
        <a href="cart.html" aria-current="page">Giỏ hàng</a>
        <a href="about_us.html">Giới thiệu</a>
        <a href="contact.html">Liên hệ</a>
        <a href="booking.html">Đặt món online</a>
        <a href="login.html">Đăng nhập</a>
        <a href="register.html">Đăng ký</a>
      </nav>
    </div>
  </header>

  <section class="cart-hero">
    <div class="container">
      <h1>Giỏ hàng của bạn</h1>
      <p class="muted">Kiểm tra, cập nhật số lượng và tiến hành thanh toán.</p>
    </div>
  </section>

  <main class="cart-wrap">
    <div class="cart-grid">
      <section>
        <div id="listArea">
            
        </div>
      </section>

      <aside>
        <div class="summary">
          <h3>Tóm tắt đơn hàng</h3>
          <div class="row"><div class="muted-small">Tạm tính</div><div id="subTotal">0 đ</div></div>
          <div class="row"><div class="muted-small">Phí giao hàng</div><div id="shipFee">0 đ</div></div>
          <div class="row"><div class="muted-small">Giảm giá</div><div id="discount">0 đ</div></div>
          <hr />
          <div class="row total"><div>Tổng</div><div id="grandTotal">0 đ</div></div>

          <div style="margin-top:12px">
            <input id="coupon" placeholder="Mã giảm giá (nếu có)" style="width:100%;padding:10px;border-radius:10px;border:1px solid #eee" />
            <div class="cart-actions">
              <button id="applyCoupon" class="btn btn-sm">Áp dụng</button>
              <button id="clearCart" class="btn btn-sm" style="background:#f3f4f6;color:var(--dark-color)">Xoá giỏ</button>
            </div>
            <div style="margin-top:12px">
              <button id="checkout" class="btn btn-checkout btn">Thanh toán</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer>© 2025 BestFood</footer>

  <script>
    const STORAGE_KEY = 'bestfood_cart';

    function currency(v){ return (Number(v)||0).toLocaleString('vi-VN') + ' đ'; }

    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch { return []; }
    }
    function saveCart(cart){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }

    function calcTotals(cart){
      const sub = cart.reduce((s,it)=> s + (Number(it.price)||0) * (Number(it.qty)||0), 0);
      const ship = sub >= 500000 ? 0 : (sub === 0 ? 0 : 20000);
      const discount = Number(localStorage.getItem('bestfood_coupon_discount') || 0);
      const grand = Math.max(0, sub + ship - discount);
      return { sub, ship, discount, grand };
    }

    function renderEmpty(){
      document.getElementById('listArea').innerHTML = `
        <div class="empty-cart">
          <p>Chưa có món nào trong giỏ.</p>
          <p style="margin-top:12px"><a href="menu.html" class="btn btn-small">Quay lại Thực đơn</a></p>
        </div>`;
      updateSummary([]);
    }

    function renderCart(){
      const cart = loadCart();
      if(!cart.length) { renderEmpty(); return; }

      const html = cart.map(it => `
        <div class="cart-item" data-id="${encodeURIComponent(it.id)}">
          <img src="${it.image || 'https://picsum.photos/320/240'}" alt="${escapeHtml(it.name)}" />
          <div class="ci-body">
            <div class="ci-title">${escapeHtml(it.name)}</div>
            <div class="ci-meta"><span class="muted-small">${it.unit || ''}</span> <span class="muted-small">| Giá: <b>${currency(it.price)}</b></span></div>
            <div class="ci-actions">
              <div class="qty-control">
                <button class="qty-dec" title="Giảm">-</button>
                <input class="qty-input" type="number" min="1" value="${it.qty || 1}" />
                <button class="qty-inc" title="Tăng">+</button>
              </div>
              <div style="margin-left:auto;font-weight:800">${currency( (Number(it.price)||0) * (Number(it.qty)||1) )}</div>
              <button class="btn-sm remove-item" style="margin-left:8px">Xoá</button>
            </div>
          </div>
        </div>
      `).join('');
      document.getElementById('listArea').innerHTML = `<div class="cart-list">${html}</div>`;
      attachItemHandlers();
      updateSummary(cart);
    }

    function updateSummary(cart){
      const t = calcTotals(cart||[]);
      document.getElementById('subTotal').textContent = currency(t.sub);
      document.getElementById('shipFee').textContent = currency(t.ship);
      document.getElementById('discount').textContent = currency(t.discount);
      document.getElementById('grandTotal').textContent = currency(t.grand);
    }

    function attachItemHandlers(){
      const list = document.querySelectorAll('.cart-item');
      list.forEach(node => {
        const id = decodeURIComponent(node.dataset.id);
        const dec = node.querySelector('.qty-dec');
        const inc = node.querySelector('.qty-inc');
        const inp = node.querySelector('.qty-input');
        const rem = node.querySelector('.remove-item');

        dec.addEventListener('click', ()=> changeQty(id, Math.max(1, Number(inp.value||1)-1)) );
        inc.addEventListener('click', ()=> changeQty(id, Number(inp.value||1)+1) );
        inp.addEventListener('change', ()=> changeQty(id, Math.max(1, Number(inp.value||1))) );
        rem.addEventListener('click', ()=> removeItem(id) );
      });
    }

    function changeQty(id, newQty){
      const cart = loadCart();
      const idx = cart.findIndex(i=> String(i.id) === String(id));
      if(idx === -1) return;
      cart[idx].qty = Number(newQty) || 1;
      saveCart(cart);
      renderCart();
    }

    function removeItem(id){
      let cart = loadCart();
      cart = cart.filter(i => String(i.id) !== String(id));
      saveCart(cart);
      renderCart();
    }

    document.getElementById('clearCart').addEventListener('click', ()=>{
      if(!confirm('Xoá toàn bộ giỏ hàng?')) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem('bestfood_coupon_discount');
      renderCart();
    });

    document.getElementById('applyCoupon').addEventListener('click', ()=>{
      const code = (document.getElementById('coupon').value || '').trim().toUpperCase();
      let discount = 0;
      const cart = loadCart();
      const sub = calcTotals(cart).sub;
      if(!code) { alert('Nhập mã giảm giá'); return; }

      if(code === 'PROMO20'){ discount = 20000; }
      else if(code === 'FIRST10' && sub >= 200000){ discount = Math.round(sub * 0.10); }
      else { alert('Mã không hợp lệ hoặc điều kiện chưa đạt'); return; }

      localStorage.setItem('bestfood_coupon_discount', String(discount));
      updateSummary(cart);
      alert('Áp dụng mã thành công!');
    });

    document.getElementById('checkout').addEventListener('click', ()=>{
      const cart = loadCart();
      if(!cart.length){ alert('Giỏ hàng trống'); return; }
      localStorage.setItem('bestfood_last_order', JSON.stringify({ items: cart, totals: calcTotals(cart), created_at: new Date().toISOString() }));
      
      alert('Thanh toán (demo): đơn hàng đã được lưu tạm. Bạn có thể xử lý gửi server ở bước tiếp theo.');
      
      window.location.href = 'datbanonl.html';
    });

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    renderCart();

    window.addEventListener('storage', (e)=>{
      if(e.key === STORAGE_KEY || e.key === 'bestfood_coupon_discount') renderCart();
    });
  </script>
</body>
</html>
